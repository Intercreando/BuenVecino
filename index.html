import 'package:lottie/lottie.dart';
import 'package:flutter/material.dart';
import 'package:image_picker/image_picker.dart';
import 'dart:io';
import 'package:pdf/pdf.dart';
import 'package:pdf/widgets.dart' as pw;
import 'package:printing/printing.dart';

// ============================================================================
//  0. GESTORES DE DATOS (LA "MEMORIA" DE LA APP)
// ============================================================================

// Guarda el estado del contrato
class GestorContrato {
  static String? contratoFinal; 
  static bool firmaInquilino = false; 
}

// Guarda el estado del inventario
class GestorInventario {
  static bool inventarioFirmado = false;
  static DateTime? fechaFirma;
}

// Guarda los tickets de mantenimiento (Compartido entre Inquilino y Due帽o)
class GestorReparaciones {
  static List<Map<String, dynamic>> tickets = [
    {
      "titulo": "Calentador no enciende",
      "categoria": "Gas / Calentador",
      "estado": "En Proceso",
      "color": Colors.orange,
      "fecha": "Hace 2 d铆as",
      "prioridad": "Alta"
    }
  ];
}

void main() {
  runApp(const BuenVecinoApp());
}

// --- 1. CONFIGURACIN GENERAL ---
class BuenVecinoApp extends StatelessWidget {
  const BuenVecinoApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      title: 'BuenVecino',
      theme: ThemeData(
        useMaterial3: true,
        fontFamily: 'Roboto',
        colorScheme: ColorScheme.fromSeed(seedColor: Colors.blue),
        scaffoldBackgroundColor: Colors.grey.shade50,
        navigationBarTheme: NavigationBarThemeData(
          backgroundColor: Colors.white,
          indicatorColor: Colors.blue.shade100,
          labelBehavior: NavigationDestinationLabelBehavior.onlyShowSelected,
        ),
      ),
      home: const PantallaLogin(),
    );
  }
}

// --- 2. PANTALLA DE LOGIN ---
class PantallaLogin extends StatelessWidget {
  const PantallaLogin({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      body: SafeArea(
        child: SingleChildScrollView(
          padding: const EdgeInsets.symmetric(horizontal: 30),
          child: Column(
            children: [
              const SizedBox(height: 60),
              Container(
                padding: const EdgeInsets.all(20),
                decoration: BoxDecoration(color: Colors.blue.shade50, shape: BoxShape.circle),
                child: Icon(Icons.home_work_rounded, size: 80, color: Colors.blue.shade700),
              ),
              const SizedBox(height: 20),
              const Text("BuenVecino", style: TextStyle(fontSize: 32, fontWeight: FontWeight.w900, color: Colors.black87)),
              const Text("Tu reputaci贸n te abre puertas", style: TextStyle(fontSize: 16, color: Colors.grey)),
              const SizedBox(height: 50),
              _buildTextField(hint: "Correo electr贸nico", icon: Icons.email_outlined),
              const SizedBox(height: 20),
              _buildTextField(hint: "Contrase帽a", icon: Icons.lock_outline, isPassword: true),
              const SizedBox(height: 10),
              Align(
                alignment: Alignment.centerRight, 
                child: TextButton(
                  onPressed: () => Navigator.push(context, MaterialPageRoute(builder: (context) => const PantallaRecuperarPassword())), 
                  child: const Text("驴Olvidaste tu contrase帽a?", style: TextStyle(color: Colors.blue))
                )
              ),
              const SizedBox(height: 30),
              SizedBox(
                width: double.infinity,
                child: ElevatedButton(
                  onPressed: () => Navigator.pushReplacement(context, MaterialPageRoute(builder: (context) => const ControladorPrincipal())),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.blue.shade700,
                    padding: const EdgeInsets.symmetric(vertical: 18),
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15)),
                    elevation: 5,
                    shadowColor: Colors.blue.withValues(alpha: 0.3),
                  ),
                  child: const Text("INICIAR SESIN", style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold)),
                ),
              ),
              const SizedBox(height: 30),
              const Text("O ingresa con", style: TextStyle(color: Colors.grey)),
              const SizedBox(height: 20),
              _buildSocialButton(label: "Continuar con Google", icon: Icons.g_mobiledata),
              const SizedBox(height: 40),
              Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  const Text("驴No tienes cuenta? "),
                  GestureDetector(
                    onTap: () => Navigator.push(context, MaterialPageRoute(builder: (context) => const PantallaRegistro())),
                    child: const Text("Reg铆strate", style: TextStyle(color: Colors.blue, fontWeight: FontWeight.bold)),
                  )
                ],
              ),
              const SizedBox(height: 20),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildTextField({required String hint, required IconData icon, bool isPassword = false}) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 15),
      decoration: BoxDecoration(color: Colors.grey.shade100, borderRadius: BorderRadius.circular(15)),
      child: TextField(obscureText: isPassword, decoration: InputDecoration(border: InputBorder.none, icon: Icon(icon, color: Colors.grey), hintText: hint, hintStyle: const TextStyle(color: Colors.grey))),
    );
  }

  Widget _buildSocialButton({required String label, required IconData icon}) {
    return Container(
      width: double.infinity,
      padding: const EdgeInsets.symmetric(vertical: 12),
      decoration: BoxDecoration(border: Border.all(color: Colors.grey.shade300), borderRadius: BorderRadius.circular(15)),
      child: Row(mainAxisAlignment: MainAxisAlignment.center, children: [Icon(icon, color: Colors.red, size: 30), const SizedBox(width: 10), Text(label, style: const TextStyle(fontWeight: FontWeight.bold, color: Colors.black87))]),
    );
  }
}

// --- 3. PANTALLA DE REGISTRO ---
class PantallaRegistro extends StatelessWidget {
  const PantallaRegistro({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        elevation: 0,
        leading: IconButton(icon: const Icon(Icons.arrow_back, color: Colors.black), onPressed: () => Navigator.pop(context)),
      ),
      body: SafeArea(
        child: SingleChildScrollView(
          padding: const EdgeInsets.symmetric(horizontal: 30),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text("Crear Cuenta", style: TextStyle(fontSize: 32, fontWeight: FontWeight.w900, color: Colors.black87)),
              const Text("nete a la comunidad de confianza", style: TextStyle(fontSize: 16, color: Colors.grey)),
              const SizedBox(height: 40),
              _buildTextField(hint: "Nombre Completo", icon: Icons.person_outline),
              const SizedBox(height: 20),
              _buildTextField(hint: "Correo electr贸nico", icon: Icons.email_outlined),
              const SizedBox(height: 20),
              _buildTextField(hint: "Contrase帽a", icon: Icons.lock_outline, isPassword: true),
              const SizedBox(height: 20),
              _buildTextField(hint: "Confirmar contrase帽a", icon: Icons.lock_outline, isPassword: true),
              const SizedBox(height: 40),
              SizedBox(
                width: double.infinity,
                child: ElevatedButton(
                  onPressed: () => Navigator.pushReplacement(context, MaterialPageRoute(builder: (context) => const ControladorPrincipal())),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.blue.shade700,
                    padding: const EdgeInsets.symmetric(vertical: 18),
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15)),
                    elevation: 5,
                    shadowColor: Colors.blue.withValues(alpha: 0.3),
                  ),
                  child: const Text("REGISTRARME", style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold)),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildTextField({required String hint, required IconData icon, bool isPassword = false}) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 15),
      decoration: BoxDecoration(color: Colors.grey.shade100, borderRadius: BorderRadius.circular(15)),
      child: TextField(obscureText: isPassword, decoration: InputDecoration(border: InputBorder.none, icon: Icon(icon, color: Colors.grey), hintText: hint, hintStyle: const TextStyle(color: Colors.grey))),
    );
  }
}

// --- 4. PANTALLA RECUPERAR CONTRASEA ---
class PantallaRecuperarPassword extends StatelessWidget {
  const PantallaRecuperarPassword({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        elevation: 0,
        leading: IconButton(icon: const Icon(Icons.arrow_back, color: Colors.black), onPressed: () => Navigator.pop(context)),
      ),
      body: SafeArea(
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 30),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const SizedBox(height: 20),
              Container(
                padding: const EdgeInsets.all(15),
                decoration: BoxDecoration(color: Colors.blue.shade50, shape: BoxShape.circle),
                child: Icon(Icons.lock_reset, size: 50, color: Colors.blue.shade700),
              ),
              const SizedBox(height: 20),
              const Text("Recuperar\nContrase帽a", style: TextStyle(fontSize: 32, fontWeight: FontWeight.w900, color: Colors.black87, height: 1.1)),
              const SizedBox(height: 15),
              const Text("Ingresa el correo asociado a tu cuenta y te enviaremos un enlace para restablecerla.", style: TextStyle(fontSize: 16, color: Colors.grey, height: 1.5)),
              const SizedBox(height: 40),
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 15),
                decoration: BoxDecoration(color: Colors.grey.shade100, borderRadius: BorderRadius.circular(15)),
                child: const TextField(decoration: InputDecoration(border: InputBorder.none, icon: Icon(Icons.email_outlined, color: Colors.grey), hintText: "Correo electr贸nico", hintStyle: TextStyle(color: Colors.grey))),
              ),
              const SizedBox(height: 40),
              SizedBox(
                width: double.infinity,
                child: ElevatedButton(
                  onPressed: () {
                    showDialog(
                      context: context,
                      builder: (context) => AlertDialog(
                        title: const Text("隆Correo Enviado!"),
                        content: const Text("Revisa tu bandeja de entrada para restablecer tu contrase帽a."),
                        actions: [
                          TextButton(
                            onPressed: () {
                              Navigator.pop(context); 
                              Navigator.pop(context); 
                            },
                            child: const Text("ENTENDIDO")
                          )
                        ],
                      )
                    );
                  },
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.blue.shade700,
                    padding: const EdgeInsets.symmetric(vertical: 18),
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15)),
                    elevation: 5,
                    shadowColor: Colors.blue.withValues(alpha: 0.3),
                  ),
                  child: const Text("ENVIAR INSTRUCCIONES", style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold)),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

// --- 5. PANTALLA CONFIGURACIN ---
class PantallaConfiguracion extends StatelessWidget {
  const PantallaConfiguracion({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.grey.shade50,
      appBar: AppBar(
        title: const Text("Configuraci贸n", style: TextStyle(fontWeight: FontWeight.bold)),
        centerTitle: true,
        backgroundColor: Colors.white,
        elevation: 0,
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          children: [
            Container(
              padding: const EdgeInsets.all(20),
              decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(20)),
              child: Row(
                children: [
                  const CircleAvatar(radius: 30, backgroundColor: Colors.blue, child: Icon(Icons.person, size: 30, color: Colors.white)),
                  const SizedBox(width: 15),
                  const Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text("Elkin B", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
                      Text("Inquilino Oro", style: TextStyle(color: Colors.amber, fontWeight: FontWeight.bold)),
                    ],
                  ),
                  const Spacer(),
                  IconButton(onPressed: () {}, icon: const Icon(Icons.edit, color: Colors.blue))
                ],
              ),
            ),
            const SizedBox(height: 30),
            _buildOption(Icons.person_outline, "Informaci贸n Personal"),
            _buildOption(Icons.notifications_none, "Notificaciones"),
            _buildOption(Icons.lock_outline, "Seguridad y Contrase帽a"),
            _buildOption(Icons.help_outline, "Ayuda y Soporte"),
            const SizedBox(height: 40),
            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                onPressed: () => Navigator.pushAndRemoveUntil(context, MaterialPageRoute(builder: (context) => const PantallaLogin()), (route) => false),
                style: ElevatedButton.styleFrom(backgroundColor: Colors.red.shade50, foregroundColor: Colors.red, padding: const EdgeInsets.symmetric(vertical: 15), shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15)), elevation: 0),
                child: const Text("CERRAR SESIN", style: TextStyle(fontWeight: FontWeight.bold)),
              ),
            ),
          ],
        ),
      ),
    );
  }
  Widget _buildOption(IconData icon, String label) {
    return Container(margin: const EdgeInsets.only(bottom: 10), decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(15)), child: ListTile(leading: Container(padding: const EdgeInsets.all(8), decoration: BoxDecoration(color: Colors.grey.shade100, borderRadius: BorderRadius.circular(10)), child: Icon(icon, color: Colors.black87)), title: Text(label, style: const TextStyle(fontWeight: FontWeight.bold)), trailing: const Icon(Icons.arrow_forward_ios, size: 16, color: Colors.grey), onTap: () {}));
  }
}

// --- 6. CONTROLADOR PRINCIPAL ---
class ControladorPrincipal extends StatefulWidget {
  const ControladorPrincipal({super.key});
  @override
  State<ControladorPrincipal> createState() => _ControladorPrincipalState();
}

class _ControladorPrincipalState extends State<ControladorPrincipal> {
  int _selectedIndex = 0;

  // Lista de pantallas corregida
  static final List<Widget> _widgetOptions = <Widget>[
    const PantallaInicio(),         // 0: Explorar
    const PantallaListaChats(),     // 1: Mensajes (Chat)
    const PantallaContratos(),      // 2: Contratos
    const PantallaReputacion(),     // 3: Perfil (CORREGIDO: Antes dec铆a PantallaPerfil)
  ];

  void _onItemTapped(int index) {
    setState(() {
      _selectedIndex = index;
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Center(
        // Verificaci贸n de seguridad para evitar pantallas blancas
        child: _widgetOptions.length > _selectedIndex 
            ? _widgetOptions.elementAt(_selectedIndex) 
            : const Text("Error: Pantalla no encontrada"),
      ),
      bottomNavigationBar: BottomNavigationBar(
        items: const <BottomNavigationBarItem>[
          BottomNavigationBarItem(
            icon: Icon(Icons.search), 
            label: 'Explorar'
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.chat_bubble_outline), 
            label: 'Mensajes'
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.description), 
            label: 'Contratos'
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.person), 
            label: 'Perfil'
          ),
        ],
        currentIndex: _selectedIndex,
        selectedItemColor: const Color(0xFF2C3E50),
        unselectedItemColor: Colors.grey,
        showUnselectedLabels: true,
        type: BottomNavigationBarType.fixed, 
        onTap: _onItemTapped,
      ),
    );
  }
}

// --- 7. PANTALLA EXPLORAR (CON CAMPANA DE NOTIFICACIONES) ---
class PantallaInicio extends StatelessWidget {
  const PantallaInicio({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.grey.shade50,
      body: SafeArea(
        child: Column(
          children: [
            Padding(
              padding: const EdgeInsets.all(20.0),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // --- CABECERA CON BOTN DE CAMPANA ---
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text(
                        "Encuentra tu\npr贸ximo hogar ",
                        style: TextStyle(fontSize: 28, fontWeight: FontWeight.w900, color: Colors.black87, height: 1.1),
                      ),
                      
                      // AQU EST LA CAMPANA 
                      Container(
                        decoration: BoxDecoration(
                          color: Colors.white,
                          shape: BoxShape.circle,
                          boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.05), blurRadius: 10)]
                        ),
                        child: IconButton(
                          icon: const Icon(Icons.notifications_none, size: 28, color: Colors.black87),
                          tooltip: "Notificaciones (Vista Propietario)",
                          onPressed: () {
                            // Navega a la pantalla de confirmaci贸n (Secci贸n 24)
                            Navigator.push(context, MaterialPageRoute(builder: (context) => const PantallaConfirmacionPropietario()));
                          },
                        ),
                      ),
                    ],
                  ),
                  // -------------------------------------

                  const SizedBox(height: 20),
                  
                  // BUSCADOR
                  Container(
                    padding: const EdgeInsets.symmetric(horizontal: 15),
                    decoration: BoxDecoration(
                      color: Colors.white,
                      borderRadius: BorderRadius.circular(15),
                      boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.05), blurRadius: 10, offset: const Offset(0, 4))]
                    ),
                    child: const TextField(
                      decoration: InputDecoration(
                        border: InputBorder.none,
                        icon: Icon(Icons.search, color: Colors.grey),
                        hintText: "驴En qu茅 barrio buscas?",
                        hintStyle: TextStyle(color: Colors.grey)
                      )
                    )
                  )
                ],
              ),
            ),

            // FILTROS
            SizedBox(
              height: 40,
              child: ListView(
                scrollDirection: Axis.horizontal,
                padding: const EdgeInsets.symmetric(horizontal: 20),
                children: const [
                  _FiltroChip(label: "Todo", activo: true),
                  _FiltroChip(label: "Apartamentos", activo: false),
                  _FiltroChip(label: "Casas", activo: false),
                  _FiltroChip(label: "Casas Campestres", activo: false),
                  _FiltroChip(label: "Habitaciones", activo: false)
                ],
              ),
            ),

            const SizedBox(height: 20),

            // LISTA DE INMUEBLES
            Expanded(
              child: ListView(
                padding: const EdgeInsets.symmetric(horizontal: 20),
                children: const [
                  // INMUEBLE 1
                  _TarjetaInmueble(
                    titulo: "Apartamento Moderno Centro",
                    precio: "\$1.200.000 / mes",
                    ubicacion: "La Candelaria, Centro",
                    imagenUrl: "https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                    dueno: "Juan P.",
                    nivelArrendador: "Arrendador Platino ",
                    rating: "4.9",
                    descripcion: "Espectacular apartamento totalmente remodelado.",
                    comodidades: ["Sala-Comedor", "Cocina Integral", "Balc贸n", "2 Habitaciones", "Gas Natural"],
                    requisitos: ["Carta Laboral", "Codeudor", "Dep贸sito", "Contrato a 6 meses", "No Mascotas"],
                    valorDeposito: "\$ 600.000"
                  ),

                  // INMUEBLE 2
                  _TarjetaInmueble(
                    titulo: "Casa Familiar con Jard铆n",
                    precio: "\$2.500.000 / mes",
                    ubicacion: "Barrio El Prado",
                    imagenUrl: "https://images.unsplash.com/photo-1564013799919-ab600027ffc6?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                    dueno: "Maria L.",
                    nivelArrendador: "Arrendador Oro ",
                    rating: "5.0",
                    descripcion: "Casa amplia ideal para familias grandes.",
                    comodidades: ["Garaje", "Patio", "4 Habitaciones", "Estudio", "Zona de Ropas"],
                    requisitos: ["Desprendibles de Pago", "Contrato a 3 meses"]
                  ),

                  // INMUEBLE 3
                  _TarjetaInmueble(
                    titulo: "Paisa Studio Loft",
                    precio: "\$950.000 / mes",
                    ubicacion: "Zona Norte",
                    imagenUrl: "https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                    dueno: "Carlos R.",
                    nivelArrendador: "Arrendador Plata ",
                    rating: "4.5",
                    descripcion: "Loft moderno perfecto para estudiantes.",
                    comodidades: ["Cocina Integral", "Closets", "1 Habitaci贸n", "Ba帽o Privado"],
                    requisitos: ["Referencias Personales", "Contrato a 1 a帽o"]
                  ),

                  SizedBox(height: 20),
                ],
              ),
            )
          ],
        ),
      ),
    );
  }
}

// --- 8. PANTALLA DETALLE ---
class PantallaDetalle extends StatelessWidget {
  final String titulo, precio, ubicacion, imagenUrl, dueno, rating, descripcion;
  final String nivelArrendador; 
  final List<String> comodidades;
  final List<String> requisitos; 
  final String? valorDeposito; 

  const PantallaDetalle({
    super.key,
    required this.titulo,
    required this.precio,
    required this.ubicacion,
    required this.imagenUrl,
    required this.dueno,
    required this.nivelArrendador, 
    required this.rating,
    required this.descripcion,
    required this.comodidades,
    required this.requisitos, 
    this.valorDeposito, 
  });

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      body: Stack(
        children: [
          SizedBox(height: 350, width: double.infinity, child: Image.network(imagenUrl, fit: BoxFit.cover)),
          SafeArea(
            child: Padding(
              padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 10),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  CircleAvatar(backgroundColor: Colors.white, child: IconButton(icon: const Icon(Icons.arrow_back, color: Colors.black), onPressed: () => Navigator.pop(context))),
                  const CircleAvatar(backgroundColor: Colors.white, child: Icon(Icons.favorite_border, color: Colors.black))
                ],
              ),
            ),
          ),
          Padding(
            padding: const EdgeInsets.only(top: 300),
            child: Container(
              width: double.infinity,
              height: double.infinity,
              decoration: const BoxDecoration(color: Colors.white, borderRadius: BorderRadius.vertical(top: Radius.circular(30))),
              child: Padding(
                padding: const EdgeInsets.all(25.0),
                child: SingleChildScrollView(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Center(child: Container(width: 40, height: 5, decoration: BoxDecoration(color: Colors.grey.shade300, borderRadius: BorderRadius.circular(10)))),
                      const SizedBox(height: 20),
                      Text(titulo, style: const TextStyle(fontSize: 24, fontWeight: FontWeight.bold, height: 1.1)),
                      const SizedBox(height: 8),
                      Text(precio, style: TextStyle(fontSize: 20, fontWeight: FontWeight.w900, color: Colors.blue.shade700)),
                      const SizedBox(height: 15),
                      Row(
                        children: [
                          const Icon(Icons.location_on, color: Colors.grey, size: 20),
                          const SizedBox(width: 5),
                          Text(ubicacion, style: const TextStyle(color: Colors.grey, fontSize: 16)),
                        ],
                      ),
                      
                      const SizedBox(height: 25),
                      const Text("Ubicaci贸n", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
                      const SizedBox(height: 15),
                      Container(
                        height: 200, 
                        width: double.infinity,
                        decoration: BoxDecoration(
                          borderRadius: BorderRadius.circular(15),
                          border: Border.all(color: Colors.grey.shade300)
                        ),
                        child: ClipRRect(
                          borderRadius: BorderRadius.circular(15),
                          child: const _MapaGoogleSimulado(isEditable: false)
                        ), 
                      ),
                      const SizedBox(height: 10),
                      SizedBox(
                        width: double.infinity,
                        child: OutlinedButton.icon(
                          onPressed: () {}, 
                          icon: const Icon(Icons.map_outlined),
                          label: const Text("Abrir en Google Maps"),
                          style: OutlinedButton.styleFrom(padding: const EdgeInsets.symmetric(vertical: 12), shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12))),
                        ),
                      ),

                      const SizedBox(height: 25),
                      Container(
                        padding: const EdgeInsets.all(15),
                        decoration: BoxDecoration(color: Colors.blue.shade50, borderRadius: BorderRadius.circular(15)),
                        child: Row(
                          children: [
                            const CircleAvatar(backgroundColor: Colors.blue, child: Icon(Icons.person, color: Colors.white)),
                            const SizedBox(width: 15),
                            Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(dueno, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
                                Text(nivelArrendador, style: const TextStyle(fontSize: 12, color: Colors.blueGrey, fontWeight: FontWeight.bold)),
                              ],
                            ),
                            const Spacer(),
                            Container(
                              padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 5),
                              decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(20)),
                              child: Row(
                                children: [
                                  const Icon(Icons.star, size: 16, color: Colors.amber),
                                  const SizedBox(width: 4),
                                  Text(rating, style: const TextStyle(fontWeight: FontWeight.bold)),
                                ],
                              ),
                            )
                          ],
                        ),
                      ),
                      
                      const SizedBox(height: 25),
                      const Text("Espacios y Caracter铆sticas", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
                      const SizedBox(height: 15),
                      Wrap(
                        spacing: 15,
                        runSpacing: 10,
                        children: comodidades.map((texto) => _ComodidadItem(icon: _buscarIcono(texto), label: texto)).toList(),
                      ),

                      const SizedBox(height: 25),
                      const Text("Requisitos para arrendar", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
                      const SizedBox(height: 5),
                      const Text("Debes cumplir con lo siguiente:", style: TextStyle(color: Colors.grey, fontSize: 14)),
                      const SizedBox(height: 15),
                      Wrap(
                        spacing: 15,
                        runSpacing: 10,
                        children: requisitos.map((req) {
                          String label = req;
                          if (req == "Dep贸sito" && valorDeposito != null) {
                            label = "$req: $valorDeposito";
                          }
                          return _ComodidadItem(
                            icon: _buscarIconoRequisito(req), 
                            label: label
                          );
                        }).toList(),
                      ),

                      const SizedBox(height: 25),
                      const Text("Descripci贸n", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
                      const SizedBox(height: 10),
                      Text(descripcion, style: const TextStyle(fontSize: 15, color: Colors.black87, height: 1.5)),
                      const SizedBox(height: 100),
                    ],
                  ),
                ),
              ),
            ),
          ),
        ],
      ),
      floatingActionButtonLocation: FloatingActionButtonLocation.centerFloat,
      floatingActionButton: Container(
        padding: const EdgeInsets.symmetric(horizontal: 20),
        width: double.infinity,
        child: Row(
          children: [
            Expanded(
              child: ElevatedButton(
                onPressed: () {
                  Navigator.push(context, MaterialPageRoute(builder: (context) => const PantallaAgendarVisita()));
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.white, 
                  foregroundColor: Colors.blue.shade700, 
                  side: BorderSide(color: Colors.blue.shade700, width: 2), 
                  padding: const EdgeInsets.symmetric(vertical: 18),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15)),
                  elevation: 0,
                ),
                child: const Text(" Agendar Visita", style: TextStyle(fontSize: 14, fontWeight: FontWeight.bold)),
              ),
            ),
            const SizedBox(width: 15),
            Expanded(
              child: ElevatedButton(
                onPressed: () {
                  Navigator.push(context, MaterialPageRoute(builder: (context) => PantallaEnviarSolicitud(
                    requisitosSolicitados: requisitos,
                    valorDeposito: valorDeposito 
                  )));
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.blue.shade700, 
                  padding: const EdgeInsets.symmetric(vertical: 18),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15)),
                  elevation: 5,
                ),
                child: const Text(" Aplicar Ahora", style: TextStyle(color: Colors.white, fontSize: 14, fontWeight: FontWeight.bold)),
              ),
            ),
          ],
        ),
      ),
    );
  }

  IconData _buscarIcono(String nombre) {
    if (nombre.contains("Wifi")) return Icons.wifi;
    if (nombre.contains("Cocina")) return Icons.kitchen;
    if (nombre.contains("Tv")) return Icons.tv;
    if (nombre.contains("Balc贸n")) return Icons.balcony;
    if (nombre.contains("Terraza")) return Icons.deck;
    if (nombre.contains("Garaje") || nombre.contains("Parqueadero")) return Icons.garage;
    if (nombre.contains("Jard铆n") || nombre.contains("Patio")) return Icons.grass;
    if (nombre.contains("Mascotas")) return Icons.pets;
    if (nombre.contains("Habitaci贸n") || nombre.contains("Hab")) return Icons.bed;
    if (nombre.contains("Estudio")) return Icons.menu_book;
    if (nombre.contains("Sala")) return Icons.weekend; 
    if (nombre.contains("Ropas") || nombre.contains("Lavadero")) return Icons.local_laundry_service;
    if (nombre.contains("Closet")) return Icons.door_sliding;
    if (nombre.contains("Gas")) return Icons.local_fire_department;
    if (nombre.contains("Ba帽o")) return Icons.bathroom;
    return Icons.check_circle;
  }

  IconData _buscarIconoRequisito(String nombre) {
    if (nombre.contains("Cedula")) return Icons.badge;
    if (nombre.contains("Laboral")) return Icons.work;
    if (nombre.contains("Codeudor")) return Icons.supervisor_account;
    if (nombre.contains("Desprendibles")) return Icons.receipt_long;
    if (nombre.contains("Extractos")) return Icons.account_balance;
    if (nombre.contains("Dep贸sito")) return Icons.savings; 
    if (nombre.contains("Referencias")) return Icons.contact_phone;
    if (nombre.contains("Contrato")) return Icons.history_edu; 
    if (nombre.contains("Mascotas")) return Icons.pets; 
    return Icons.assignment;
  }
}

// --- 9. PANTALLA CONTRATOS (GESTIN, PAGOS, INVENTARIO Y MANTENIMIENTO) ---
class PantallaContratos extends StatelessWidget {
  const PantallaContratos({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.grey.shade50,
      appBar: AppBar(
        backgroundColor: Colors.white, 
        elevation: 0, 
        title: const Text("Mis Arriendos", style: TextStyle(color: Colors.black, fontWeight: FontWeight.bold)), 
        centerTitle: true, 
        actions: [IconButton(icon: const Icon(Icons.help_outline, color: Colors.black), onPressed: () {})]
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // 1. ALERTA CONTRATO PENDIENTE (Naranja)
            GestureDetector(
              onTap: () {
                Navigator.push(context, MaterialPageRoute(builder: (context) => const PantallaRevisarContrato()));
              },
              child: Container(
                width: double.infinity,
                margin: const EdgeInsets.only(bottom: 25),
                padding: const EdgeInsets.all(20),
                decoration: BoxDecoration(color: Colors.orange.shade50, borderRadius: BorderRadius.circular(20), border: Border.all(color: Colors.orange.shade200)),
                child: Row(
                  children: [
                    Container(padding: const EdgeInsets.all(10), decoration: BoxDecoration(color: Colors.orange.shade100, shape: BoxShape.circle), child: const Icon(Icons.edit_document, color: Colors.orange)),
                    const SizedBox(width: 15),
                    const Expanded(child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [Text("Contrato Pendiente", style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16, color: Colors.black87)), Text("Apto 402 - Edificio Centenario", style: TextStyle(fontSize: 12, color: Colors.black54)), Text("Toca para revisar y firmar", style: TextStyle(fontWeight: FontWeight.bold, color: Colors.orange, fontSize: 12))])),
                    const Icon(Icons.arrow_forward_ios, size: 14, color: Colors.orange)
                  ],
                ),
              ),
            ),
            
            // 2. TARJETA DE PAGO (AZUL GRANDE CON RACHA)
            Container(
              width: double.infinity, 
              padding: const EdgeInsets.all(25), 
              decoration: BoxDecoration(
                gradient: const LinearGradient(colors: [Color(0xFF1565C0), Color(0xFF1E88E5)], begin: Alignment.topLeft, end: Alignment.bottomRight), 
                borderRadius: BorderRadius.circular(25), 
                boxShadow: [BoxShadow(color: Colors.blue.withOpacity(0.3), blurRadius: 15, offset: const Offset(0, 8))]
              ), 
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start, 
                children: [
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween, 
                    children: [
                      Container(
                        padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 5),
                        decoration: BoxDecoration(color: Colors.white.withOpacity(0.2), borderRadius: BorderRadius.circular(20)),
                        child: const Row(
                          children: [
                            Icon(Icons.local_fire_department, color: Colors.orangeAccent, size: 18),
                            SizedBox(width: 5),
                            Text("Racha: 5 Meses", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 12)),
                          ],
                        ),
                      ),
                      Container(
                        padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 5), 
                        decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(20)), 
                        child: const Text("Vence en 5 d铆as", style: TextStyle(color: Colors.blue, fontWeight: FontWeight.bold, fontSize: 12))
                      )
                    ]
                  ), 
                  
                  const SizedBox(height: 15), 
                  const Text("\$1.200.000", style: TextStyle(color: Colors.white, fontSize: 36, fontWeight: FontWeight.bold)), 
                  const SizedBox(height: 5), 
                  const Text("Apto 402 - Edificio Centenario", style: TextStyle(color: Colors.white, fontSize: 14)), 
                  const SizedBox(height: 20),
                  
                  // Bot贸n Pagar Conectado
                  SizedBox(
                    width: double.infinity, 
                    child: ElevatedButton(
                      onPressed: () { 
                        Navigator.push(context, MaterialPageRoute(builder: (c) => const PantallaPasarelaPago(
                          monto: "\$1.200.000", 
                          concepto: "Canon Enero 2026"
                        )));
                      }, 
                      style: ElevatedButton.styleFrom(backgroundColor: Colors.white, foregroundColor: Colors.blue.shade900, padding: const EdgeInsets.symmetric(vertical: 15), shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15)), elevation: 0), 
                      child: const Text("PAGAR Y MANTENER RACHA", style: TextStyle(fontWeight: FontWeight.w900, fontSize: 14))
                    )
                  )
                ]
              )
            ),
            
            const SizedBox(height: 30),
            
            // 3. GESTIN (AQU EST EL CAMBIO IMPORTANTE)
            const Text("Gesti贸n del Inmueble", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)), 
            const SizedBox(height: 15), 
            Row(mainAxisAlignment: MainAxisAlignment.spaceBetween, children: [
                // Bot贸n Contrato
                GestureDetector(
                  onTap: () => Navigator.push(context, MaterialPageRoute(builder: (context) => const PantallaRevisarContrato())),
                  child: const _BotonAccion(icon: Icons.assignment, label: "Ver\nContrato", color: Color(0xFFF3E5F5), iconColor: Colors.purple)
                ),
                
                // Bot贸n Inventario
                GestureDetector(
                  onTap: () => Navigator.push(context, MaterialPageRoute(builder: (context) => const PantallaInventario())),
                  child: const _BotonAccion(icon: Icons.assignment_turned_in, label: "Acta\nEntrega", color: Color(0xFFFFF3E0), iconColor: Colors.orange)
                ),
                
                // --- NUEVO: BOTN MANTENIMIENTO (REPARACIONES) ---
                GestureDetector(
                  onTap: () => Navigator.push(context, MaterialPageRoute(builder: (context) => const PantallaMantenimiento())),
                  child: const _BotonAccion(icon: Icons.build, label: "Reparaciones", color: Color(0xFFE3F2FD), iconColor: Colors.blue)
                ),
            ]),
            
            const SizedBox(height: 30),
            
            // 4. HISTORIAL
            const Text("Historial Reciente", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)), 
            const SizedBox(height: 15), 
            const _ItemHistorial(mes: "Enero 2026", estado: "Pagado a tiempo", colorEstado: Colors.green, fecha: "05 Ene"), 
            const _ItemHistorial(mes: "Diciembre 2025", estado: "Pagado a tiempo", colorEstado: Colors.green, fecha: "04 Dic"), 
            const SizedBox(height: 20),
          ],
        ),
      ),
    );
  }
}

// --- 10. PANTALLA PERFIL ---
class PantallaReputacion extends StatelessWidget {
  const PantallaReputacion({super.key});
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      extendBodyBehindAppBar: true,
      appBar: AppBar(
        backgroundColor: Colors.transparent, 
        elevation: 0, 
        title: const Text('Mi Reputaci贸n', style: TextStyle(color: Colors.black87, fontWeight: FontWeight.bold)), 
        centerTitle: true, 
        actions: [
          IconButton(icon: const Icon(Icons.settings, color: Colors.black87), onPressed: () => Navigator.push(context, MaterialPageRoute(builder: (c) => const PantallaConfiguracion())))
        ]
      ),
      body: Container(
        decoration: BoxDecoration(gradient: LinearGradient(begin: Alignment.topCenter, end: Alignment.bottomCenter, colors: [Colors.blue.shade50, Colors.white], stops: const [0.0, 0.5])),
        child: SingleChildScrollView(
          padding: const EdgeInsets.fromLTRB(20, 110, 20, 20),
          child: Column(
            children: [
              Stack(alignment: Alignment.bottomRight, children: [Container(decoration: BoxDecoration(shape: BoxShape.circle, boxShadow: [BoxShadow(color: Colors.blue.withValues(alpha: 0.25), blurRadius: 25, offset: const Offset(0, 10))]), child: const CircleAvatar(radius: 60, backgroundColor: Colors.white, child: CircleAvatar(radius: 56, backgroundColor: Color(0xFF00B0FF), child: Icon(Icons.person, size: 65, color: Colors.white)))), Container(padding: const EdgeInsets.all(4), decoration: BoxDecoration(color: Colors.white, shape: BoxShape.circle, boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.1), blurRadius: 5)]), child: const Icon(Icons.verified, color: Colors.blue, size: 24))]),
              const SizedBox(height: 15),
              Row(mainAxisAlignment: MainAxisAlignment.center, children: [Container(padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8), decoration: BoxDecoration(gradient: const LinearGradient(colors: [Color(0xFFFFE082), Color(0xFFFFCA28)], begin: Alignment.topLeft, end: Alignment.bottomRight), borderRadius: BorderRadius.circular(30), boxShadow: [BoxShadow(color: Colors.amber.shade200.withValues(alpha: 0.5), blurRadius: 8, offset: const Offset(0, 4))]), child: const Row(children: [Text("Inquilino ORO", style: TextStyle(fontWeight: FontWeight.w800, color: Color(0xFF5D4037), fontSize: 14))])), const SizedBox(width: 8), const Text("", style: TextStyle(fontSize: 28, shadows: [Shadow(blurRadius: 10, color: Colors.black12, offset: Offset(0,4))]))]),
              const SizedBox(height: 10), const Text("Elkin B", style: TextStyle(fontSize: 26, fontWeight: FontWeight.w900, color: Colors.black87)), const SizedBox(height: 25),
              // Tarjeta Reputacion
              Container(width: double.infinity, padding: const EdgeInsets.all(25), decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(30), boxShadow: [BoxShadow(color: Colors.blueGrey.withValues(alpha: 0.1), blurRadius: 30, offset: const Offset(0, 15))]), child: Column(children: [const Text("4.9", style: TextStyle(fontSize: 72, fontWeight: FontWeight.w900, height: 1, color: Colors.black87)), const SizedBox(height: 10), Row(mainAxisAlignment: MainAxisAlignment.center, children: [for (int i = 0; i < 5; i++) Icon(Icons.star_rounded, size: 38, color: Colors.amber.shade600)]), const SizedBox(height: 30), Column(children: [Padding(padding: const EdgeInsets.symmetric(horizontal: 4.0), child: Row(mainAxisAlignment: MainAxisAlignment.spaceBetween, children: [Text("Nivel Oro", style: TextStyle(fontSize: 13, fontWeight: FontWeight.bold, color: Colors.amber.shade800)), const Text("Platino", style: TextStyle(fontSize: 13, fontWeight: FontWeight.bold, color: Colors.grey))])), const SizedBox(height: 8), Stack(children: [Container(height: 14, width: double.infinity, decoration: BoxDecoration(color: const Color(0xFFE0E0E0), borderRadius: BorderRadius.circular(10))), Container(height: 14, width: 220, decoration: BoxDecoration(gradient: const LinearGradient(colors: [Color(0xFF43A047), Color(0xFF66BB6A)]), borderRadius: BorderRadius.circular(10), boxShadow: const [BoxShadow(color: Colors.greenAccent, blurRadius: 6, offset: Offset(0,2))]))])]), const SizedBox(height: 20), Text("隆Est谩s a solo 120 puntos del\nNivel Platino! ", textAlign: TextAlign.center, style: TextStyle(fontSize: 15, fontWeight: FontWeight.w500, color: Colors.grey.shade600, height: 1.4)), const SizedBox(height: 35), const Row(mainAxisAlignment: MainAxisAlignment.spaceBetween, children: [_StatItem(icon: Icons.access_time_filled_rounded, label: "100%\nPuntual"), _StatItem(icon: Icons.home_work_rounded, label: "2\nArriendos"), _StatItem(icon: Icons.verified_user_rounded, label: "Identidad\nVerificada")])])),
              const SizedBox(height: 30),
              // NUEVA SECCIN: MODO PROPIETARIO
              const Align(alignment: Alignment.centerLeft, child: Text("Zona Propietario", style: TextStyle(fontSize: 20, fontWeight: FontWeight.w800, color: Colors.black87))), 
              const SizedBox(height: 15),
              GestureDetector(
                onTap: () {
                  // Entra directamente al panel
                  Navigator.push(context, MaterialPageRoute(builder: (context) => const PantallaModoPropietario())); 
                },
                child: Container(
                  padding: const EdgeInsets.all(20),
                  decoration: BoxDecoration(
                    gradient: const LinearGradient(colors: [Color(0xFF2C3E50), Color(0xFF4CA1AF)]), // Azul oscuro profesional
                    borderRadius: BorderRadius.circular(20),
                    boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.2), blurRadius: 15, offset: const Offset(0, 5))]
                  ),
                  child: const Row(
                    children: [
                      Icon(Icons.real_estate_agent_rounded, color: Colors.white, size: 40),
                      SizedBox(width: 15),
                      Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text("Modo Propietario", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 16)),
                          Text("Gestiona tus inmuebles", style: TextStyle(color: Colors.white70, fontSize: 12)),
                        ],
                      ),
                      Spacer(),
                      Icon(Icons.arrow_forward_ios, color: Colors.white, size: 16)
                    ],
                  ),
                ),
              ),
              const SizedBox(height: 40),
            ],
          ),
        ),
      ),
    );
  }
}

// --- 11-A. PANTALLA VERIFICACIN PROPIETARIO ---
class PantallaVerificacionPropietario extends StatefulWidget {
  final bool cedulaOk;
  final bool bancoOk;
  
  const PantallaVerificacionPropietario({super.key, this.cedulaOk = false, this.bancoOk = false});

  @override
  State<PantallaVerificacionPropietario> createState() => _PantallaVerificacionPropietarioState();
}

class _PantallaVerificacionPropietarioState extends State<PantallaVerificacionPropietario> {
  late bool _cedulaSubida;
  late bool _bancoSubido;

  @override
  void initState() {
    super.initState();
    // Cargamos el estado actual (si ya subi贸 algo, que aparezca marcado)
    _cedulaSubida = widget.cedulaOk;
    _bancoSubido = widget.bancoOk;
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        title: const Text("Configuraci贸n Arrendador", style: TextStyle(color: Colors.black, fontWeight: FontWeight.bold)),
        backgroundColor: Colors.white,
        elevation: 0,
        leading: IconButton(icon: const Icon(Icons.close, color: Colors.black), onPressed: () => Navigator.pop(context)),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(25),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Text("Estado de tu Cuenta ★", style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold)),
            const SizedBox(height: 10),
            const Text("Completa los pasos faltantes para activar todas las funciones.", style: TextStyle(color: Colors.grey, fontSize: 14)),
            const SizedBox(height: 40),
            
            // 1. C茅dula
            Row(
              children: [
                Text("1. Documento de Identidad", style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: _cedulaSubida ? Colors.green : Colors.black)),
                if (_cedulaSubida) const Padding(padding: EdgeInsets.only(left: 8.0), child: Icon(Icons.check_circle, color: Colors.green, size: 18))
              ],
            ),
            const SizedBox(height: 10),
            GestureDetector(
              onTap: () {
                 if(!_cedulaSubida) {
                   setState(() { _cedulaSubida = true; });
                   ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Documento cargado correctamente")));
                 }
              },
              child: Container(
                height: 100, 
                width: double.infinity,
                decoration: BoxDecoration(
                  color: _cedulaSubida ? Colors.green.shade50 : Colors.grey.shade100,
                  borderRadius: BorderRadius.circular(15),
                  border: Border.all(color: _cedulaSubida ? Colors.green : Colors.grey.shade300, style: BorderStyle.solid)
                ),
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Icon(_cedulaSubida ? Icons.verified_user : Icons.camera_alt, size: 30, color: _cedulaSubida ? Colors.green : Colors.grey),
                    const SizedBox(height: 5),
                    Text(_cedulaSubida ? "Identidad Verificada " : "Toca para subir foto de tu C茅dula", style: TextStyle(color: _cedulaSubida ? Colors.green : Colors.grey, fontWeight: FontWeight.bold)),
                  ],
                ),
              ),
            ),

            const SizedBox(height: 30),
            
            // 2. Cuenta Bancaria
            Row(
              children: [
                Text("2. Datos Bancarios", style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: _bancoSubido ? Colors.green : Colors.black)),
                 if (_bancoSubido) const Padding(padding: EdgeInsets.only(left: 8.0), child: Icon(Icons.check_circle, color: Colors.green, size: 18))
              ],
            ),
            const SizedBox(height: 15),
            if (!_bancoSubido) ...[
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 15),
                decoration: BoxDecoration(color: Colors.grey.shade100, borderRadius: BorderRadius.circular(12)),
                child: const TextField(decoration: InputDecoration(border: InputBorder.none, icon: Icon(Icons.account_balance, color: Colors.grey), hintText: "Banco (Ej: Bancolombia)")),
              ),
              const SizedBox(height: 15),
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 15),
                decoration: BoxDecoration(color: Colors.grey.shade100, borderRadius: BorderRadius.circular(12)),
                child: const TextField(keyboardType: TextInputType.number, decoration: InputDecoration(border: InputBorder.none, icon: Icon(Icons.numbers, color: Colors.grey), hintText: "N煤mero de Cuenta")),
              ),
            ] else 
              Container(
                padding: const EdgeInsets.all(15),
                width: double.infinity,
                decoration: BoxDecoration(color: Colors.green.shade50, borderRadius: BorderRadius.circular(15), border: Border.all(color: Colors.green)),
                child: const Text("Cuenta Bancaria Verificada: ⑩⑩⑩ 4590", style: TextStyle(color: Colors.green, fontWeight: FontWeight.bold)),
              ),

            const SizedBox(height: 50),
            
            // Bot贸n inteligente
            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                onPressed: () {
                  if (!_cedulaSubida) {
                     ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("A煤n falta tu identidad"), backgroundColor: Colors.red));
                     return;
                  }
                  
                  // Simulamos guardar el banco si no estaba listo
                  if (!_bancoSubido) {
                     setState(() => _bancoSubido = true);
                  }

                  showDialog(
                    context: context, 
                    barrierDismissible: false,
                    builder: (context) {
                      Future.delayed(const Duration(seconds: 1), () {
                        if (context.mounted) {
                          Navigator.pop(context); // Cierra el c铆rculo de carga
                          
                          // AQU EST EL AJUSTE CLAVE: Devolvemos 'true'
                          Navigator.pop(context, true); 
                          
                          ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("隆Perfil actualizado con 茅xito!"), backgroundColor: Colors.green));
                        }
                      });
                      return const Center(child: CircularProgressIndicator());
                    }
                  );
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFF2C3E50),
                  padding: const EdgeInsets.symmetric(vertical: 18),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15))
                ),
                child: Text((_cedulaSubida && _bancoSubido) ? "VOLVER AL PANEL" : "GUARDAR Y ACTIVAR", style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
              ),
            )
          ],
        ),
      ),
    );
  }
}

// --- 11-B. PANTALLA MODO PROPIETARIO (CON BANDEJA DE MENSAJES Y MANTENIMIENTO) ---
class PantallaModoPropietario extends StatefulWidget {
  const PantallaModoPropietario({super.key});

  @override
  State<PantallaModoPropietario> createState() => _PantallaModoPropietarioState();
}

class _PantallaModoPropietarioState extends State<PantallaModoPropietario> {
  // SIMULACIN DE ESTADOS
  bool _cedulaVerificada = false; 
  bool _cuentaBancariaVerificada = false; 

  bool get _estaTotalmenteVerificado => _cedulaVerificada && _cuentaBancariaVerificada;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.grey.shade100,
      appBar: AppBar(
        title: const Text("Panel de Propietario", style: TextStyle(fontWeight: FontWeight.bold, color: Colors.white)),
        centerTitle: true,
        backgroundColor: const Color(0xFF2C3E50),
        elevation: 0,
        leading: IconButton(icon: const Icon(Icons.arrow_back, color: Colors.white), onPressed: () => Navigator.pop(context)),
        actions: [
          IconButton(
            icon: const Icon(Icons.settings, color: Colors.white),
            onPressed: () async {
               // Navegamos y esperamos respuesta por si actualiza algo en ajustes
               final resultado = await Navigator.push(context, MaterialPageRoute(builder: (context) => PantallaVerificacionPropietario(
                 cedulaOk: _cedulaVerificada, 
                 bancoOk: _cuentaBancariaVerificada
               )));

               if (resultado == true) {
                 setState(() {
                   _cedulaVerificada = true;
                   _cuentaBancariaVerificada = true;
                 });
               }
            },
          )
        ],
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            
            // --- ALERTA INTELIGENTE ---
            if (!_estaTotalmenteVerificado)
            GestureDetector(
              onTap: () async {
                  final resultado = await Navigator.push(context, MaterialPageRoute(builder: (context) => PantallaVerificacionPropietario(cedulaOk: _cedulaVerificada, bancoOk: _cuentaBancariaVerificada)));
                  if (resultado == true) {
                    setState(() {
                      _cedulaVerificada = true;
                      _cuentaBancariaVerificada = true;
                    });
                  }
              },
              child: Container(
                margin: const EdgeInsets.only(bottom: 20),
                padding: const EdgeInsets.all(15),
                decoration: BoxDecoration(color: Colors.orange.shade50, borderRadius: BorderRadius.circular(15), border: Border.all(color: Colors.orange.shade200)),
                child: Row(
                  children: [
                    Icon(Icons.warning_amber_rounded, color: Colors.orange.shade800),
                    const SizedBox(width: 10),
                    Expanded(
                      child: Text(
                        _cedulaVerificada 
                          ? "Faltan tus datos bancarios para recibir pagos." 
                          : "Tu perfil no est谩 verificado. Compl茅talo ahora.", 
                        style: TextStyle(color: Colors.orange.shade900, fontSize: 12, fontWeight: FontWeight.bold)
                      )
                    ),
                    const Icon(Icons.arrow_forward_ios, size: 14, color: Colors.orange)
                  ],
                ),
              ),
            ),
            
             // --- TARJETA DE REPUTACION DEL PROPIETARIO ---
            Container(
              margin: const EdgeInsets.only(bottom: 25),
              padding: const EdgeInsets.all(20),
              decoration: BoxDecoration(
                gradient: const LinearGradient(colors: [Color(0xFF37474F), Color(0xFF546E7A)]), 
                borderRadius: BorderRadius.circular(20),
                boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.3), blurRadius: 15, offset: const Offset(0, 8))]
              ),
              child: Column(
                children: [
                  Row(
                    children: [
                      const CircleAvatar(
                        radius: 30, 
                        backgroundColor: Colors.white, 
                        child: CircleAvatar(radius: 28, backgroundColor: Color(0xFF37474F), child: Icon(Icons.person, color: Colors.white))
                      ),
                      const SizedBox(width: 15),
                      Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text("Juan P.", style: TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.bold)),
                          Row(
                            children: [
                              const Icon(Icons.verified, color: Colors.blueAccent, size: 16),
                              const SizedBox(width: 5),
                              Container(
                                padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                                decoration: BoxDecoration(color: Colors.white.withOpacity(0.2), borderRadius: BorderRadius.circular(10)),
                                child: const Text("Arrendador Plata", style: TextStyle(color: Colors.white, fontSize: 12, fontWeight: FontWeight.bold))
                              )
                            ],
                          )
                        ],
                      ),
                      const Spacer(),
                      const Column(
                        children: [
                           Text("850", style: TextStyle(color: Colors.amber, fontSize: 24, fontWeight: FontWeight.bold)),
                           Text("Puntos", style: TextStyle(color: Colors.white70, fontSize: 10)),
                        ],
                      )
                    ],
                  ),
                  const SizedBox(height: 20),
                  // BARRA DE PROGRESO
                  Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          const Text("Nivel Plata", style: TextStyle(color: Colors.white70, fontSize: 10)),
                          Text("Siguiente: Oro (1000 pts)", style: TextStyle(color: Colors.amber.shade200, fontSize: 10, fontWeight: FontWeight.bold)),
                        ],
                      ),
                      const SizedBox(height: 5),
                      Stack(
                        children: [
                          Container(height: 8, width: double.infinity, decoration: BoxDecoration(color: Colors.white.withOpacity(0.1), borderRadius: BorderRadius.circular(10))),
                          Container(height: 8, width: 240, decoration: BoxDecoration(gradient: LinearGradient(colors: [Colors.blue, Colors.blue.shade200]), borderRadius: BorderRadius.circular(10))), 
                        ],
                      ),
                      const SizedBox(height: 8),
                      const Text(" Tip: Valida visitas a tiempo para sumar +50 puntos.", style: TextStyle(color: Colors.white54, fontSize: 11, fontStyle: FontStyle.italic)),
                    ],
                  )
                ],
              ),
            ),
            
            // Tarjeta de Ganancias
            Container(
              padding: const EdgeInsets.all(25),
              decoration: BoxDecoration(
                gradient: const LinearGradient(colors: [Color(0xFF11998e), Color(0xFF38ef7d)]),
                borderRadius: BorderRadius.circular(20),
                boxShadow: [BoxShadow(color: Colors.green.withOpacity(0.3), blurRadius: 15, offset: const Offset(0, 8))]
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Text("Ingresos Totales (Enero)", style: TextStyle(color: Colors.white70)),
                  const SizedBox(height: 5),
                  const Text("\$ 2.400.000", style: TextStyle(color: Colors.white, fontSize: 36, fontWeight: FontWeight.bold)),
                  const SizedBox(height: 20),
                  Row(
                    children: [
                      Container(padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 5), decoration: BoxDecoration(color: Colors.white.withOpacity(0.2), borderRadius: BorderRadius.circular(20)), child: const Text("+ 12% vs Dic", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 12))),
                      const Spacer(),
                      const Icon(Icons.trending_up, color: Colors.white),
                    ],
                  )
                ],
              ),
            ),

            // BOTN DE MENSAJERA
            const SizedBox(height: 25),
            GestureDetector(
              onTap: () {
                // Redirige al chat mostrando inquilinos
                Navigator.push(context, MaterialPageRoute(builder: (c) => const PantallaListaChats(esVistaPropietario: true)));
              },
              child: Container(
                padding: const EdgeInsets.all(15),
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.circular(15),
                  boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.05), blurRadius: 10, offset: const Offset(0, 5))]
                ),
                child: Row(
                  children: [
                    Container(
                      padding: const EdgeInsets.all(12),
                      decoration: BoxDecoration(color: Colors.blue.shade50, shape: BoxShape.circle),
                      child: const Icon(Icons.mail_outline, color: Colors.blue, size: 28),
                    ),
                    const SizedBox(width: 15),
                    const Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text("Bandeja de Entrada", style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
                        Text("Mensajes de inquilinos", style: TextStyle(color: Colors.grey, fontSize: 12)),
                      ],
                    ),
                    const Spacer(),
                    Container(
                      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 5),
                      decoration: BoxDecoration(color: Colors.red, borderRadius: BorderRadius.circular(10)),
                      child: const Text("2 Nuevos", style: TextStyle(color: Colors.white, fontSize: 10, fontWeight: FontWeight.bold)),
                    ),
                    const SizedBox(width: 10),
                    const Icon(Icons.arrow_forward_ios, size: 14, color: Colors.grey),
                  ],
                ),
              ),
            ),

            const SizedBox(height: 30),
            Row(mainAxisAlignment: MainAxisAlignment.spaceBetween, children: [const Text("Mis Propiedades", style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold)), TextButton(onPressed: () {}, child: const Text("Ver Todo"))]),
            const SizedBox(height: 10),
            const _PropiedadCard(nombre: "Apto Centro Hist贸rico", estado: "Ocupado", colorEstado: Colors.green, inquilino: "Juan P."),
            const _PropiedadCard(nombre: "Loft Zona Norte", estado: "Disponible", colorEstado: Colors.orange, inquilino: "Sin inquilino"),
            
            const SizedBox(height: 30),
            const Text("Accesos R谩pidos", style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
            const SizedBox(height: 15),
            
            // --- ACCESOS RPIDOS (CONEXIONES REALES) ---
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                // 1. Solicitudes
                _AccesoRapido(
                  icon: Icons.request_quote, 
                  label: "Solicitudes", 
                  color: Colors.blue, 
                  onTap: () {
                    Navigator.push(context, MaterialPageRoute(builder: (context) => const PantallaSolicitudes()));
                  }
                ), 
                
                // 2. Mantenimiento (CONECTADO A LA GESTIN DE REPARACIONES)
                _AccesoRapido(
                  icon: Icons.build, 
                  label: "Mantenimiento", 
                  color: Colors.orange, 
                  onTap: () {
                    // Navega a la pantalla de gesti贸n del propietario (Secci贸n 27)
                    Navigator.push(context, MaterialPageRoute(builder: (context) => const PantallaAdminReparaciones()));
                  }
                ), 
                
                // 3. Estad铆sticas
                const _AccesoRapido(icon: Icons.bar_chart, label: "Estad铆sticas", color: Colors.purple)
              ],
            ),
            const SizedBox(height: 80),
          ],
        ),
      ),
      floatingActionButton: FloatingActionButton.extended(
        onPressed: () async {
          // --- LOGICA INTELIGENTE DEL BOTON ---
          if (_estaTotalmenteVerificado) {
             // 1. Si tiene todo OK -> Publicar
             Navigator.push(context, MaterialPageRoute(builder: (context) => const PantallaPublicarInmueble()));
          } else {
             // 2. Si le falta algo -> Mostrar di谩logo
             String mensajeFaltante = "";
             if (!_cedulaVerificada) mensajeFaltante += "- Documento de Identidad\n";
             if (!_cuentaBancariaVerificada) mensajeFaltante += "- Cuenta Bancaria";

             showDialog(context: context, builder: (context) => AlertDialog(
               title: const Text("Completa tu Perfil"),
               content: Text("Para publicar y recibir pagos, necesitamos:\n\n$mensajeFaltante"),
               actions: [
                 TextButton(onPressed: () => Navigator.pop(context), child: const Text("Cancelar")),
                 ElevatedButton(
                   onPressed: () async {
                     Navigator.pop(context); // Cierra dialogo
                     
                     // Vamos a verificar y ESPERAMOS (await) a que vuelva
                     final resultado = await Navigator.push(
                       context, 
                       MaterialPageRoute(builder: (context) => PantallaVerificacionPropietario(cedulaOk: _cedulaVerificada, bancoOk: _cuentaBancariaVerificada))
                     );

                     // Si volvi贸 con 茅xito (true)
                     if (resultado == true) {
                       setState(() {
                         _cedulaVerificada = true;
                         _cuentaBancariaVerificada = true;
                       });
                       
                       // 隆Redirecci贸n autom谩tica a Publicar!
                       if (context.mounted) {
                          Navigator.push(context, MaterialPageRoute(builder: (context) => const PantallaPublicarInmueble()));
                       }
                     }
                   }, 
                   child: const Text("Completar Ahora")
                 )
               ],
             ));
          }
        },
        backgroundColor: _estaTotalmenteVerificado ? const Color(0xFF2C3E50) : Colors.redAccent, 
        icon: Icon(_estaTotalmenteVerificado ? Icons.add : Icons.priority_high, color: Colors.white),
        label: const Text("PUBLICAR INMUEBLE", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
      ),
      floatingActionButtonLocation: FloatingActionButtonLocation.centerFloat,
    );
  }
}

// --- 12. PANTALLA PUBLICAR INMUEBLE ---
class PantallaPublicarInmueble extends StatefulWidget {
  const PantallaPublicarInmueble({super.key});

  @override
  State<PantallaPublicarInmueble> createState() => _PantallaPublicarInmuebleState();
}

class _PantallaPublicarInmuebleState extends State<PantallaPublicarInmueble> {
  final Set<String> _comodidades = {};
  final Set<String> _requisitos = {};
  String? _tipoInmuebleSeleccionado;
  final List<String> _tiposInmueble = ["Apartamento", "Casa", "Casa Campestre", "Habitaci贸n"];

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        title: const Text("Nueva Propiedad", style: TextStyle(color: Colors.black, fontWeight: FontWeight.bold)),
        backgroundColor: Colors.white,
        elevation: 0,
        leading: IconButton(icon: const Icon(Icons.close, color: Colors.black), onPressed: () => Navigator.pop(context)),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Container(
              height: 200,
              width: double.infinity,
              decoration: BoxDecoration(color: Colors.grey.shade100, borderRadius: BorderRadius.circular(20), border: Border.all(color: Colors.grey.shade300, style: BorderStyle.solid)),
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(Icons.add_a_photo, size: 50, color: Colors.grey.shade400),
                  const SizedBox(height: 10),
                  Text("Toca para subir fotos", style: TextStyle(color: Colors.grey.shade600, fontWeight: FontWeight.bold)),
                ],
              ),
            ),
            const SizedBox(height: 30),
            const Text("Detalles del Inmueble", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
            const SizedBox(height: 20),
            
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 15),
              decoration: BoxDecoration(color: Colors.grey.shade100, borderRadius: BorderRadius.circular(12), border: Border.all(color: Colors.grey.shade300)),
              child: DropdownButtonFormField<String>(
                decoration: const InputDecoration(border: InputBorder.none),
                hint: const Text("Tipo de Inmueble", style: TextStyle(color: Colors.grey)),
                value: _tipoInmuebleSeleccionado,
                items: _tiposInmueble.map((String tipo) {
                  return DropdownMenuItem<String>(
                    value: tipo,
                    child: Text(tipo),
                  );
                }).toList(),
                onChanged: (String? newValue) {
                  setState(() {
                    _tipoInmuebleSeleccionado = newValue;
                  });
                },
              ),
            ),
            const SizedBox(height: 20),
            
            _buildInput(label: "T铆tulo del anuncio", hint: "Ej: Apartamento con vista al parque"),
            const SizedBox(height: 20),
            Row(children: [Expanded(child: _buildInput(label: "Precio (Mensual)", hint: "\$ 0.000.000", isNumber: true)), const SizedBox(width: 20), Expanded(child: _buildInput(label: "rea (m虏)", hint: "Ej: 65", isNumber: true))]),
            const SizedBox(height: 20),
            _buildInput(label: "Direcci贸n / Barrio", hint: "Ej: Calle 123, La Candelaria"),
            
            const SizedBox(height: 20),
            const Text("Ubicaci贸n en el Mapa", style: TextStyle(fontWeight: FontWeight.bold, color: Colors.black87)),
            const SizedBox(height: 8),
            Container(
              height: 180,
              width: double.infinity,
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(15),
                border: Border.all(color: Colors.grey.shade300),
              ),
              child: ClipRRect(
                borderRadius: BorderRadius.circular(15),
                child: const _MapaGoogleSimulado(isEditable: true), 
              ),
            ),

            const SizedBox(height: 20),
            _buildInput(label: "Descripci贸n", hint: "Cuenta un poco sobre tu inmueble...", maxLines: 4),
            const SizedBox(height: 30),
            const Text("Espacios y Caracter铆sticas", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
            const SizedBox(height: 15),
            Wrap(spacing: 10, runSpacing: 10, children: [
              _buildChip("Sala-Comedor", _comodidades),
              _buildChip("Cocina Integral", _comodidades), 
              _buildChip("Zona de Ropas", _comodidades), 
              _buildChip("Estudio", _comodidades), 
              _buildChip("Balc贸n", _comodidades), 
              _buildChip("Patio", _comodidades), 
              _buildChip("Garaje", _comodidades), 
              _buildChip("Gas Natural", _comodidades),
              _buildChip("Closets", _comodidades),
            ]),
            
            const SizedBox(height: 30),
            const Text("Requisitos para arrendar", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
            const SizedBox(height: 5),
            const Text("Selecciona qu茅 documentos o condiciones pides al inquilino:", style: TextStyle(color: Colors.grey)),
            const SizedBox(height: 15),
            Wrap(
              spacing: 10, 
              runSpacing: 10, 
              children: [
                _buildChip("Cedula", _requisitos, isRed: true), 
                _buildChip("Carta Laboral", _requisitos, isRed: true), 
                _buildChip("Codeudor", _requisitos, isRed: true), 
                _buildChip("Referencias Personales", _requisitos, isRed: true),
                _buildChip("Desprendibles de Pago", _requisitos, isRed: true), 
                _buildChip("Extractos Bancarios", _requisitos, isRed: true), 
                
                _buildChip("Dep贸sito", _requisitos, isRed: true), 
                _buildChip("Contrato a 1 a帽o", _requisitos, isRed: true),
                _buildChip("Contrato a 6 meses", _requisitos, isRed: true), 
              
                _buildChip("No Mascotas", _requisitos, isRed: true), 
              ]
            ),
            
            if (_requisitos.contains("Dep贸sito"))
              Padding(
                padding: const EdgeInsets.only(top: 20),
                child: _buildInput(label: "Valor del Dep贸sito", hint: "Ej: \$ 600.000", isNumber: true),
              ),

            const SizedBox(height: 40),
            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                onPressed: () {
                  showDialog(context: context, builder: (context) => AlertDialog(icon: const Icon(Icons.check_circle, color: Colors.green, size: 60), title: const Text("隆Publicado con xito!"), content: const Text("Tu inmueble est谩 siendo revisado y pronto estar谩 visible para miles de inquilinos."), actions: [TextButton(onPressed: () { Navigator.pop(context); Navigator.pop(context); }, child: const Text("IR AL PANEL"))]));
                },
                style: ElevatedButton.styleFrom(backgroundColor: const Color(0xFF2C3E50), padding: const EdgeInsets.symmetric(vertical: 18), shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15)), elevation: 5),
                child: const Text("PUBLICAR AHORA", style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold)),
              ),
            ),
            const SizedBox(height: 20),
          ],
        ),
      ),
    );
  }

  Widget _buildInput({required String label, required String hint, bool isNumber = false, int maxLines = 1}) {
    return Column(crossAxisAlignment: CrossAxisAlignment.start, children: [Text(label, style: const TextStyle(fontWeight: FontWeight.bold, color: Colors.black87)), const SizedBox(height: 8), Container(padding: const EdgeInsets.symmetric(horizontal: 15), decoration: BoxDecoration(color: Colors.grey.shade100, borderRadius: BorderRadius.circular(12), border: Border.all(color: Colors.grey.shade300)), child: TextField(keyboardType: isNumber ? TextInputType.number : TextInputType.text, maxLines: maxLines, decoration: InputDecoration(border: InputBorder.none, hintText: hint, hintStyle: const TextStyle(color: Colors.grey))))]);
  }

  Widget _buildChip(String label, Set<String> conjunto, {bool isRed = false}) {
    final isSelected = conjunto.contains(label);
    final selectedColor = isRed ? Colors.red.shade100 : Colors.blue.shade100;
    final checkColor = isRed ? Colors.red.shade900 : Colors.blue.shade900;
    return FilterChip(
      label: Text(label), 
      selected: isSelected, 
      selectedColor: selectedColor, 
      checkmarkColor: checkColor, 
      labelStyle: TextStyle(color: isSelected ? checkColor : Colors.black87, fontWeight: isSelected ? FontWeight.bold : FontWeight.normal), 
      onSelected: (bool selected) { setState(() { if (selected) { conjunto.add(label); } else { conjunto.remove(label); } }); }
    );
  }
}

class PantallaEnviarSolicitud extends StatefulWidget {
  final List<String> requisitosSolicitados;
  final String? valorDeposito; 
  const PantallaEnviarSolicitud({super.key, this.requisitosSolicitados = const [], this.valorDeposito});

  @override
  State<PantallaEnviarSolicitud> createState() => _PantallaEnviarSolicitudState();
}

class _PantallaEnviarSolicitudState extends State<PantallaEnviarSolicitud> {
  final Map<String, bool> _requisitosCumplidos = {};
  bool _soyIndependiente = false;
  final List<String> _tiposDocumentos = ["Carta Laboral", "Codeudor", "Referencias Personales", "Desprendibles de Pago", "Extractos Bancarios"];

  @override
  void initState() {
    super.initState();
    for (var req in widget.requisitosSolicitados) {
      _requisitosCumplidos[req] = false;
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.grey.shade50,
      appBar: AppBar(
        title: const Text("Solicitud de Arriendo", style: TextStyle(fontWeight: FontWeight.bold)),
        centerTitle: true,
        backgroundColor: Colors.white,
        elevation: 0,
        leading: IconButton(icon: const Icon(Icons.close, color: Colors.black), onPressed: () => Navigator.pop(context)),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Container(
              padding: const EdgeInsets.all(15),
              decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(15), border: Border.all(color: Colors.grey.shade200)),
              child: Row(
                children: [
                  Container(width: 60, height: 60, decoration: BoxDecoration(color: Colors.grey.shade200, borderRadius: BorderRadius.circular(10)), child: const Icon(Icons.home, color: Colors.grey)),
                  const SizedBox(width: 15),
                  const Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text("Apto Moderno Centro", style: TextStyle(fontWeight: FontWeight.bold)),
                      Text("\$1.200.000 / mes", style: TextStyle(color: Colors.blue, fontWeight: FontWeight.bold)),
                    ],
                  )
                ],
              ),
            ),
            const SizedBox(height: 30),
            
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 15, vertical: 10),
              decoration: BoxDecoration(color: Colors.blue.shade50, borderRadius: BorderRadius.circular(15), border: Border.all(color: Colors.blue.shade100)),
              child: SwitchListTile(
                title: const Text("驴Eres Trabajador Independiente?", style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                subtitle: const Text("Reemplaza Carta Laboral por Extractos", style: TextStyle(fontSize: 12)),
                value: _soyIndependiente,
                activeTrackColor: Colors.blue,
                onChanged: (val) => setState(() => _soyIndependiente = val),
              ),
            ),
            const SizedBox(height: 20),

            if (widget.requisitosSolicitados.isNotEmpty) ...[
              const Text("Requisitos de la Aplicaci贸n", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
              const SizedBox(height: 15),
              Container(
                padding: const EdgeInsets.all(15),
                decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(15), boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 10)]),
                child: Column(
                  children: widget.requisitosSolicitados.map((req) {
                    String nombreRequisito = req;
                    if (_soyIndependiente && req == "Carta Laboral") nombreRequisito = "Extractos Bancarios";
                    final cumplido = _requisitosCumplidos[req] ?? false;
                    final esDocumento = _tiposDocumentos.contains(nombreRequisito); 
                    final esDeposito = req.contains("Dep贸sito");

                    return Padding(
                      padding: const EdgeInsets.only(bottom: 15),
                      child: Row(
                        children: [
                          Icon(cumplido ? Icons.check_circle : (esDeposito ? Icons.monetization_on : Icons.circle_outlined), color: cumplido ? Colors.green : (esDeposito ? Colors.orange : Colors.grey)),
                          const SizedBox(width: 10),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(nombreRequisito, style: TextStyle(fontWeight: FontWeight.bold, color: cumplido ? Colors.black87 : Colors.black54)),
                                if (esDeposito && widget.valorDeposito != null)
                                  Text("Valor: ${widget.valorDeposito}", style: const TextStyle(fontSize: 10, color: Colors.orange, fontWeight: FontWeight.bold))
                              ],
                            ),
                          ),
                          if (esDocumento) 
                            ElevatedButton(
                              onPressed: () => setState(() => _requisitosCumplidos[req] = !cumplido),
                              style: ElevatedButton.styleFrom(backgroundColor: cumplido ? Colors.white : Colors.blue.shade50, foregroundColor: cumplido ? Colors.red : Colors.blue, elevation: 0),
                              child: Text(cumplido ? "Quitar" : "Subir"),
                            )
                          else 
                            Switch(value: cumplido, activeTrackColor: Colors.green, onChanged: (val) => setState(() => _requisitosCumplidos[req] = val))
                        ],
                      ),
                    );
                  }).toList(),
                ),
              ),
              const SizedBox(height: 30),
            ],

            const Text("Mensaje al Arrendador", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
            const SizedBox(height: 10),
            Container(padding: const EdgeInsets.symmetric(horizontal: 15), decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(15), border: Border.all(color: Colors.grey.shade300)), child: const TextField(maxLines: 4, decoration: InputDecoration(border: InputBorder.none, hintText: "Hola, estoy interesado...", hintStyle: TextStyle(color: Colors.grey)))),
            const SizedBox(height: 40),
            
            // --- BOTN CON MS ESPACIO ABAJO ---
            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                onPressed: () {
                   showDialog(context: context, builder: (context) => AlertDialog(icon: const Icon(Icons.send, color: Colors.blue, size: 60), title: const Text("隆Solicitud Enviada!"), content: const Text("El arrendador ha recibido tu perfil."), actions: [TextButton(onPressed: () { Navigator.pop(context); Navigator.pop(context); }, child: const Text("ENTENDIDO"))]));
                },
                style: ElevatedButton.styleFrom(backgroundColor: Colors.blue.shade700, padding: const EdgeInsets.symmetric(vertical: 18), shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15)), elevation: 5),
                child: const Text("ENVIAR SOLICITUD", style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold)),
              ),
            ),
            
            // AQU EST EL AJUSTE FINAL PARA TU XIAOMI (M谩s espacio al final del scroll)
            const SizedBox(height: 60), 
          ],
        ),
      ),
    );
  }
}

// --- 14. PANTALLA AGENDAR VISITA (CON INCENTIVOS Y AJUSTE XIAOMI) ---
class PantallaAgendarVisita extends StatefulWidget {
  const PantallaAgendarVisita({super.key});

  @override
  State<PantallaAgendarVisita> createState() => _PantallaAgendarVisitaState();
}

class _PantallaAgendarVisitaState extends State<PantallaAgendarVisita> {
  DateTime? _selectedDate; 
  String _horaSeleccionada = "10:00 AM";
  bool _citaConfirmada = false; 

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        title: const Text("Agendar Visita", style: TextStyle(fontWeight: FontWeight.bold, color: Colors.black)),
        centerTitle: true,
        backgroundColor: Colors.white,
        elevation: 0,
        leading: IconButton(icon: const Icon(Icons.close, color: Colors.black), onPressed: () => Navigator.pop(context)),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: _citaConfirmada 
        ? _buildTicketVisita() 
        : _buildFormularioVisita(), 
      ),
    );
  }

  Widget _buildFormularioVisita() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const Text("Elige una fecha", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
        const SizedBox(height: 15),
        
        // --- 1. SELECTOR DE FECHA ---
        GestureDetector(
          onTap: () async {
            final now = DateTime.now(); 
            final DateTime? picked = await showDatePicker(
              context: context,
              initialDate: now,
              firstDate: now,
              lastDate: DateTime(2030), 
              builder: (context, child) {
                return Theme(data: Theme.of(context).copyWith(colorScheme: ColorScheme.light(primary: Colors.blue.shade700, onPrimary: Colors.white, onSurface: Colors.black)), child: child!);
              },
            );
            if (picked != null) setState(() => _selectedDate = picked);
          },
          child: Container(
            padding: const EdgeInsets.all(15),
            decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(15), border: Border.all(color: Colors.blue.shade200), boxShadow: [BoxShadow(color: Colors.blue.withValues(alpha: 0.1), blurRadius: 10, offset: const Offset(0, 4))]),
            child: Row(children: [const Icon(Icons.calendar_month, color: Colors.blue, size: 28), const SizedBox(width: 15), Column(crossAxisAlignment: CrossAxisAlignment.start, children: [Text(_selectedDate == null ? "Seleccionar Fecha" : "Fecha Seleccionada", style: const TextStyle(color: Colors.grey, fontSize: 12)), Text(_selectedDate == null ? "Toque para abrir calendario" : "${_selectedDate!.day}/${_selectedDate!.month}/${_selectedDate!.year}", style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 18))]), const Spacer(), const Icon(Icons.arrow_forward_ios, size: 16, color: Colors.grey)]),
          ),
        ),
        
        const SizedBox(height: 30),
        const Text("Horarios Disponibles", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
        const SizedBox(height: 15),
        
        // --- 2. SELECTOR DE HORA (CHIPS) ---
        Wrap(spacing: 10, runSpacing: 10, children: ["9:00 AM", "10:00 AM", "11:30 AM", "2:00 PM", "4:30 PM"].map((h) => _TimeChip(label: h, selected: _horaSeleccionada == h, onTap: () => setState(() => _horaSeleccionada = h))).toList()),
        
        const SizedBox(height: 30),

        // --- 3. NUEVA TARJETA DE INCENTIVOS (GAMIFICACIN) ---
        Container(
          padding: const EdgeInsets.all(15),
          decoration: BoxDecoration(
            color: const Color(0xFFE8EAF6), // Fondo azul muy suave
            borderRadius: BorderRadius.circular(15),
            border: Border.all(color: const Color(0xFFC5CAE9))
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text(" Importante: Tu Reputaci贸n", style: TextStyle(fontWeight: FontWeight.bold, color: Color(0xFF283593))),
              const SizedBox(height: 10),
              
              // Fila Ganar Puntos
              Row(
                children: [
                  const Icon(Icons.check_circle, color: Colors.green, size: 20),
                  const SizedBox(width: 10),
                  const Expanded(child: Text("Si asistes puntual:", style: TextStyle(fontSize: 13, color: Colors.black87))),
                  Container(
                    padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                    decoration: BoxDecoration(color: Colors.green.shade100, borderRadius: BorderRadius.circular(8)),
                    child: const Text("+50 Pts", style: TextStyle(color: Colors.green, fontWeight: FontWeight.bold, fontSize: 12)),
                  )
                ],
              ),
              const SizedBox(height: 8),
              
              // Fila Perder Puntos
              Row(
                children: [
                  const Icon(Icons.cancel, color: Colors.red, size: 20),
                  const SizedBox(width: 10),
                  const Expanded(child: Text("Si faltas sin cancelar:", style: TextStyle(fontSize: 13, color: Colors.black87))),
                  Container(
                    padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                    decoration: BoxDecoration(color: Colors.red.shade100, borderRadius: BorderRadius.circular(8)),
                    child: const Text("-20 Pts", style: TextStyle(color: Colors.red, fontWeight: FontWeight.bold, fontSize: 12)),
                  )
                ],
              ),
            ],
          ),
        ),

        const SizedBox(height: 30),
        
        // --- 4. BOTN CONFIRMAR (CON PADDING PARA TU XIAOMI) ---
        Padding(
          padding: const EdgeInsets.only(bottom: 30), // <--- ESTO EVITA QUE SE PEGUE A LA BARRA DE GESTOS
          child: SizedBox(
            width: double.infinity, 
            child: ElevatedButton(
              onPressed: () { 
                if (_selectedDate == null) { 
                  ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Por favor selecciona una fecha"), backgroundColor: Colors.red)); 
                  return; 
                } 
                setState(() => _citaConfirmada = true); 
              }, 
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.black, 
                padding: const EdgeInsets.symmetric(vertical: 18), 
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15)), 
                elevation: 5
              ), 
              child: const Text("CONFIRMAR CITA", style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold))
            )
          ),
        ),
      ],
    );
  }

  Widget _buildTicketVisita() {
    return Column(children: [
        const Icon(Icons.check_circle, color: Colors.green, size: 80), const SizedBox(height: 20), const Text("隆Cita Confirmada!", style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold)), const SizedBox(height: 10), const Text("Muestra este c贸digo al arrendador\ncuando llegues a la visita.", textAlign: TextAlign.center, style: TextStyle(color: Colors.grey)),
        const SizedBox(height: 30),
        Container(padding: const EdgeInsets.all(15), decoration: BoxDecoration(color: Colors.black87, borderRadius: BorderRadius.circular(15)), child: const Row(mainAxisAlignment: MainAxisAlignment.center, children: [Icon(Icons.timer_outlined, color: Colors.amber, size: 24), SizedBox(width: 10), Text("Faltan: 2 d铆as, 14 horas", style: TextStyle(color: Colors.amber, fontWeight: FontWeight.bold, fontSize: 16))])),
        const SizedBox(height: 30),
        Container(width: double.infinity, padding: const EdgeInsets.all(30), decoration: BoxDecoration(color: Colors.blue.shade50, borderRadius: BorderRadius.circular(20), border: Border.all(color: Colors.blue.shade200, width: 2)), child: const Column(children: [Text("CDIGO DE VISITA", style: TextStyle(letterSpacing: 2, color: Colors.blueGrey, fontWeight: FontWeight.bold)), SizedBox(height: 10), Text("5820", style: TextStyle(fontSize: 60, fontWeight: FontWeight.w900, color: Colors.blue, letterSpacing: 5))])),
        const SizedBox(height: 20),
        SizedBox(width: double.infinity, child: OutlinedButton(onPressed: () => Navigator.pop(context), style: OutlinedButton.styleFrom(padding: const EdgeInsets.symmetric(vertical: 18), shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15))), child: const Text("VOLVER AL INICIO")))
    ]);
  }
}

// --- 15. PANTALLA SOLICITUDES (VERSIN AVANZADA CON VALIDACIN) ---
class PantallaSolicitudes extends StatelessWidget {
  const PantallaSolicitudes({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.grey.shade100,
      appBar: AppBar(
        title: const Text("Solicitudes Recibidas", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
        backgroundColor: const Color(0xFF2C3E50),
        iconTheme: const IconThemeData(color: Colors.white),
        elevation: 0,
      ),
      body: ListView(
        padding: const EdgeInsets.all(20),
        children: const [
          _TarjetaSolicitud(nombre: "Elkin B", inmueble: "Apto Moderno Centro", mensaje: "Hola, adjunto todo. Quedo atento.", rating: "4.9", nivel: "Inquilino Oro", tiempo: "Hace 2 horas", mudanzas: "1 en 3 a帽os", pagos: "12 meses puntual", esIndependiente: true, documentosAdjuntos: ["Extractos_Bancarios.pdf"], condicionesAceptadas: ["Dep贸sito", "No Mascotas", "Contrato a 6 meses"]),
          _TarjetaVisita(nombre: "Laura M.", inmueble: "Apto Moderno Centro", fecha: "Ma帽ana", hora: "10:00 AM", mensaje: "Hola, quisiera ver el apartamento.", tiempo: "Hace 15 min", rating: "4.8", nivel: "Inquilino Plata", mudanzas: "2 en 5 a帽os", pagos: "1 retraso leve"),
          _TarjetaSolicitud(nombre: "Maria Garcia", inmueble: "Apto Moderno Centro", mensaje: "Buenas tardes, me interesa mucho.", rating: "3.5", nivel: "Inquilino Nuevo", tiempo: "Hace 5 horas", mudanzas: "3 en 1 a帽o", pagos: "Sin historial", esIndependiente: false, documentosAdjuntos: ["Cedula.jpg", "Carta_Laboral.pdf"], condicionesAceptadas: ["Contrato a 6 meses"]),
        ],
      ),
    );
  }
}


// --- 16. PANTALLA REVISAR CONTRATO (CON EL BOTN MS ARRIBA) ---
class PantallaRevisarContrato extends StatelessWidget {
  const PantallaRevisarContrato({super.key});

  @override
  Widget build(BuildContext context) {
    // Verificamos si hay algo en el buz贸n
    String textoAMostrar = GestorContrato.contratoFinal ?? "A煤n no hay un contrato generado por el propietario.\n\nPor favor espera a que tu solicitud sea aprobada y el contrato sea redactado.";
    bool hayContrato = GestorContrato.contratoFinal != null;

    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(title: const Text("Revisar Contrato", style: TextStyle(color: Colors.black, fontWeight: FontWeight.bold)), backgroundColor: Colors.white, elevation: 0, leading: IconButton(icon: const Icon(Icons.arrow_back, color: Colors.black), onPressed: () => Navigator.pop(context))),
      body: Column(
        children: [
          Expanded(
            child: SingleChildScrollView(
              padding: const EdgeInsets.all(25), 
              child: Container(
                width: double.infinity,
                padding: const EdgeInsets.all(15),
                decoration: hayContrato ? BoxDecoration(color: Colors.white, border: Border.all(color: Colors.grey.shade300), boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 10)]) : null,
                child: Text(
                  textoAMostrar, 
                  style: TextStyle(
                    height: 1.5, 
                    fontSize: 16, 
                    color: hayContrato ? Colors.black87 : Colors.grey, 
                    fontFamily: hayContrato ? "Courier" : "Roboto",
                    fontStyle: hayContrato ? FontStyle.normal : FontStyle.italic
                  )
                ),
              )
            )
          ),
          
          // Solo mostramos el bot贸n de FIRMAR si realmente hay un contrato
          if (hayContrato)
          Container(
            // --- AQU EST EL AJUSTE: Subimos el padding inferior a 70 ---
            padding: const EdgeInsets.only(left: 20, right: 20, top: 20, bottom: 70),
            decoration: BoxDecoration(color: Colors.white, boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 10, offset: const Offset(0, -5))]), 
            child: SizedBox(
              width: double.infinity, 
              child: ElevatedButton.icon(
                onPressed: () => Navigator.push(context, MaterialPageRoute(builder: (context) => const PantallaFirmaDigital())), 
                icon: const Icon(Icons.edit), 
                label: const Text("FIRMAR CONTRATO", style: TextStyle(fontWeight: FontWeight.bold)), 
                style: ElevatedButton.styleFrom(backgroundColor: const Color(0xFF2C3E50), foregroundColor: Colors.white, padding: const EdgeInsets.symmetric(vertical: 15), shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15)))
              )
            )
          )
        ],
      ),
    );
  }
}

// --- 17. PANTALLA FIRMA DIGITAL (CON BIOMETRA Y BOTN SUBIDO) ---
class PantallaFirmaDigital extends StatefulWidget {
  const PantallaFirmaDigital({super.key});
  @override
  State<PantallaFirmaDigital> createState() => _PantallaFirmaDigitalState();
}

class _PantallaFirmaDigitalState extends State<PantallaFirmaDigital> {
  List<Offset?> points = [];
  bool _procesando = false; 

  // Funci贸n que simula el escaneo biom茅trico
  Future<bool> _solicitarBiometria() async {
    return await showModalBottomSheet<bool>(
      context: context,
      backgroundColor: Colors.transparent,
      isDismissible: false,
      enableDrag: false,
      builder: (context) {
        return Container(
          height: 350,
          decoration: const BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.vertical(top: Radius.circular(30)),
          ),
          padding: const EdgeInsets.all(30),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              const Text("Autenticaci贸n Requerida", style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
              const SizedBox(height: 10),
              const Text("Usa tu huella o rostro para blindar el contrato.", textAlign: TextAlign.center, style: TextStyle(color: Colors.grey)),
              const SizedBox(height: 40),
              
              // Animaci贸n simulada del lector de huella
              TweenAnimationBuilder<double>(
                tween: Tween(begin: 0.0, end: 1.0),
                duration: const Duration(seconds: 2),
                builder: (context, value, child) {
                  Color colorIcono = Colors.grey;
                  if (value > 0.3) colorIcono = Colors.blue;
                  if (value == 1.0) colorIcono = Colors.green;

                  return Container(
                    padding: const EdgeInsets.all(20),
                    decoration: BoxDecoration(
                      shape: BoxShape.circle,
                      border: Border.all(color: colorIcono.withOpacity(0.3), width: 2),
                      color: colorIcono.withOpacity(0.1)
                    ),
                    child: Icon(
                      value == 1.0 ? Icons.check_circle : Icons.fingerprint, 
                      size: 60, 
                      color: colorIcono
                    ),
                  );
                },
                onEnd: () {
                  Navigator.pop(context, true); 
                },
              ),
              const SizedBox(height: 30),
              const Text("Escaneando biometr铆a...", style: TextStyle(fontSize: 12, fontWeight: FontWeight.bold, color: Colors.blueGrey)),
            ],
          ),
        );
      },
    ) ?? false; 
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        title: const Text("Firma y Seguridad"), 
        backgroundColor: Colors.white, 
        foregroundColor: Colors.black, 
        elevation: 0, 
        actions: [
          TextButton(
            onPressed: () => setState(() => points.clear()), 
            child: const Text("Borrar", style: TextStyle(color: Colors.red))
          )
        ]
      ),
      body: Column(
        children: [
          Container(
            padding: const EdgeInsets.all(15),
            color: Colors.blue.shade50,
            child: Row(
              children: [
                const Icon(Icons.security, color: Colors.blue),
                const SizedBox(width: 10),
                Expanded(child: Text("Por seguridad, este contrato requerir谩 validaci贸n biom茅trica al finalizar.", style: TextStyle(color: Colors.blue.shade900, fontSize: 12)))
              ],
            ),
          ),
          const Padding(
            padding: EdgeInsets.all(20), 
            child: Align(alignment: Alignment.centerLeft, child: Text("1. Dibuja tu firma aqu铆:", style: TextStyle(fontWeight: FontWeight.bold)))
          ),
          Expanded(
            child: Container(
              margin: const EdgeInsets.symmetric(horizontal: 20), 
              decoration: BoxDecoration(
                border: Border.all(color: Colors.grey.shade300, width: 2), 
                borderRadius: BorderRadius.circular(15),
                color: Colors.grey.shade50
              ), 
              child: GestureDetector(
                onPanUpdate: (d) => setState(() => points.add(d.localPosition)),
                onPanEnd: (d) => points.add(null),
                child: CustomPaint(painter: _SignaturePainter(points), size: Size.infinite),
              )
            )
          ),
          
          // --- AQU EST EL AJUSTE: MS PADDING INFERIOR ---
          Padding(
            // Antes era all(20), ahora le damos 80 abajo para subirlo
            padding: const EdgeInsets.fromLTRB(20, 20, 20, 80), 
            child: SizedBox(
              width: double.infinity, 
              child: ElevatedButton.icon(
                onPressed: _procesando ? null : () async {
                  if (points.isEmpty) { 
                    ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Debes firmar primero"))); 
                    return; 
                  }
                  
                  setState(() => _procesando = true);

                  // 1. SOLICITAR BIOMETRA
                  bool autenticado = await _solicitarBiometria();

                  if (!autenticado) {
                     setState(() => _procesando = false);
                     return;
                  }
                  
                  // 2. PROCESAR
                  GestorContrato.firmaInquilino = true;

                  // 3. GENERAR PDF
                  final pdf = pw.Document();
                  
                  pdf.addPage(pw.Page(build: (format) => pw.Column(
                    crossAxisAlignment: pw.CrossAxisAlignment.start,
                    children: [
                      pw.Header(level: 0, child: pw.Text("CONTRATO DE ARRENDAMIENTO", style: pw.TextStyle(fontWeight: pw.FontWeight.bold, fontSize: 20))),
                      pw.SizedBox(height: 20),
                      pw.Text(GestorContrato.contratoFinal ?? "Contrato Generado"),
                      pw.SizedBox(height: 40),
                      pw.Divider(),
                      
                      pw.Text("Firmado digitalmente el ${DateTime.now().toString()}", style: pw.TextStyle(color: PdfColors.black, fontWeight: pw.FontWeight.bold)),
                      pw.Container(
                        margin: const pw.EdgeInsets.only(top: 10, bottom: 20),
                        padding: const pw.EdgeInsets.all(10),
                        decoration: pw.BoxDecoration(border: pw.Border.all(color: PdfColors.grey)), 
                        child: pw.Text("[Firma Gr谩fica Capturada]")
                      ),

                      pw.Container(
                        padding: const pw.EdgeInsets.all(10),
                        decoration: pw.BoxDecoration(
                          color: PdfColors.green50,
                          border: pw.Border.all(color: PdfColors.green),
                          borderRadius: const pw.BorderRadius.all(pw.Radius.circular(5))
                        ),
                        child: pw.Row(
                          children: [
                            pw.Container(
                              width: 20, height: 20, 
                              decoration: const pw.BoxDecoration(color: PdfColors.green, shape: pw.BoxShape.circle)
                            ),
                            pw.SizedBox(width: 10),
                            pw.Column(
                              crossAxisAlignment: pw.CrossAxisAlignment.start,
                              children: [
                                pw.Text("AUTENTICACIN BIOMTRICA VERIFICADA", style: pw.TextStyle(color: PdfColors.green900, fontWeight: pw.FontWeight.bold, fontSize: 10)),
                                pw.Text("ID Dispositivo: 884-XIAOMI-SECURE  Huella/Rostro Match", style: const pw.TextStyle(color: PdfColors.grey700, fontSize: 8)),
                              ]
                            )
                          ]
                        )
                      )
                    ]
                  )));

                  await Printing.layoutPdf(onLayout: (format) async => pdf.save(), name: 'Contrato_BuenVecino_Biometrico.pdf');

                  if (context.mounted) {
                    setState(() => _procesando = false);
                    Navigator.pop(context); 
                    Navigator.pop(context); 
                    
                    ScaffoldMessenger.of(context).showSnackBar(
                      const SnackBar(
                        content: Text("隆Contrato blindado y firmado! "), 
                        backgroundColor: Colors.green
                      )
                    );
                  }
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFF2C3E50), 
                  foregroundColor: Colors.white, 
                  padding: const EdgeInsets.symmetric(vertical: 18),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15))
                ),
                icon: const Icon(Icons.fingerprint),
                label: const Text("AUTENTICAR Y FIRMAR", style: TextStyle(fontWeight: FontWeight.bold))
              )
            )
          )
        ],
      ),
    );
  }
}



class _SignaturePainter extends CustomPainter {
  final List<Offset?> points;
  _SignaturePainter(this.points);
  @override void paint(Canvas canvas, Size size) { Paint paint = Paint()..color = Colors.black..strokeCap = StrokeCap.round..strokeWidth = 3.0; for (int i = 0; i < points.length - 1; i++) { if (points[i] != null && points[i + 1] != null) canvas.drawLine(points[i]!, points[i + 1]!, paint); } }
  @override bool shouldRepaint(_SignaturePainter oldDelegate) => true;
}

// --- 18. PANTALLA CONFIGURAR CONTRATO (LEY 820 COLOMBIA) ---
class PantallaConfigurarContrato extends StatefulWidget {
  final String nombreInquilino;
  final String nombrePropietario;
  final String inmueble;
  final String canon;

  const PantallaConfigurarContrato({
    super.key, 
    required this.nombreInquilino,
    required this.nombrePropietario, // En una app real, esto viene del perfil del usuario logueado
    required this.inmueble,
    required this.canon
  });

  @override
  State<PantallaConfigurarContrato> createState() => _PantallaConfigurarContratoState();
}

class _PantallaConfigurarContratoState extends State<PantallaConfigurarContrato> {
  DateTime _fechaInicio = DateTime.now();
  int _duracionMeses = 12; 
  int _diaPago = 5; 
  bool _incluyeAdministracion = true;
  bool _clausulaPenal = true; 
  bool _renunciaRequerimientos = true; 
  bool _clausulaDanos = true; // <--- NUEVA VARIABLE

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.grey.shade50,
      appBar: AppBar(
        title: const Text("Configurar Contrato ", style: TextStyle(fontWeight: FontWeight.bold, color: Colors.black)),
        backgroundColor: Colors.white,
        elevation: 0,
        leading: const BackButton(color: Colors.black),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            _buildResumenHeader(),
            const SizedBox(height: 25),
            const Text("Condiciones del Arriendo", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
            const SizedBox(height: 15),
            
            // FORMULARIO DE CONFIGURACIN
            Container(
              padding: const EdgeInsets.all(20),
              decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(15)),
              child: Column(
                children: [
                  _buildDateSelector("Fecha de Inicio", _fechaInicio, (d) => setState(() => _fechaInicio = d)),
                  const Divider(),
                  _buildDropdown("Duraci贸n del Contrato", _duracionMeses, (v) => setState(() => _duracionMeses = v!)),
                  const Divider(),
                  _buildDiaPagoSelector(),
                ],
              ),
            ),

            const SizedBox(height: 25),
            const Text("Cl谩usulas de Protecci贸n (Ley 820)", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
            const SizedBox(height: 5),
            const Text("Estas opciones blindan legalmente tu inmueble.", style: TextStyle(fontSize: 12, color: Colors.grey)),
            const SizedBox(height: 15),

            // CLAUSULAS DE PROTECCIN
            Container(
              padding: const EdgeInsets.all(15),
              decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(15), border: Border.all(color: Colors.blue.shade100)),
              child: Column(
                children: [
                  _buildSwitch(
                    "Cl谩usula Penal (Multa)", 
                    "Si incumple, debe pagar 2 c谩nones de multa.", 
                    _clausulaPenal, 
                    (v) => setState(() => _clausulaPenal = v)
                  ),
                  const Divider(),
                  _buildSwitch(
                    "Responsabilidad por Da帽os", // <--- NUEVO SWITCH
                    "El inquilino paga cualquier da帽o que no sea deterioro natural.", 
                    _clausulaDanos, 
                    (v) => setState(() => _clausulaDanos = v),
                    isVital: true
                  ),
                  const Divider(),
                  _buildSwitch(
                    "Renuncia a Requerimientos", 
                    "锔 VITAL: Permite desalojo r谩pido sin avisos judiciales previos.", 
                    _renunciaRequerimientos, 
                    (v) => setState(() => _renunciaRequerimientos = v),
                    isVital: true
                  ),
                  const Divider(),
                  _buildSwitch(
                    "Incluye Administraci贸n", 
                    "El valor del canon ya cubre la cuota de la copropiedad.", 
                    _incluyeAdministracion, 
                    (v) => setState(() => _incluyeAdministracion = v)
                  ),
                ],
              ),
            ),

            const SizedBox(height: 40),
            SizedBox(
              width: double.infinity,
              child: ElevatedButton.icon(
                onPressed: () {
                   String contratoFinal = _generarTextoLegal();
                   Navigator.push(context, MaterialPageRoute(builder: (context) => PantallaVistaPreviaContrato(textoContrato: contratoFinal)));
                },
                style: ElevatedButton.styleFrom(backgroundColor: const Color(0xFF2C3E50), padding: const EdgeInsets.symmetric(vertical: 18), shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15))),
                icon: const Icon(Icons.gavel, color: Colors.white),
                label: const Text("GENERAR CONTRATO OFICIAL", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
              ),
            ),
            const SizedBox(height: 30),
          ],
        ),
      ),
    );
  }

  // --- GENERADOR DE TEXTO LEGAL COLOMBIA ---
  String _generarTextoLegal() {
    String fechaInicioStr = "${_fechaInicio.day}/${_fechaInicio.month}/${_fechaInicio.year}";
    String texto = """
CONTRATO DE ARRENDAMIENTO DE VIVIENDA URBANA
Lugar y fecha de celebraci贸n: Medell铆n, ${DateTime.now().day}/${DateTime.now().month}/${DateTime.now().year}

ARRENDADOR: ${widget.nombrePropietario.toUpperCase()}
ARRENDATARIO: ${widget.nombreInquilino.toUpperCase()}

CONDICIONES GENERALES:

PRIMERA - OBJETO: El Arrendador entrega al Arrendatario a t铆tulo de arrendamiento el inmueble ubicado en: ${widget.inmueble}, destinado exclusivamente para VIVIENDA URBANA.

SEGUNDA - CANON: El valor mensual ser谩 de ${widget.canon}, pagaderos dentro de los primeros $_diaPago d铆as de cada mes. ${_incluyeAdministracion ? 'Este valor INCLUYE la cuota de administraci贸n.' : 'El Arrendatario pagar谩 por aparte la administraci贸n.'}

TERCERA - VIGENCIA: El t茅rmino de duraci贸n ser谩 de $_duracionMeses MESES, contados a partir del $fechaInicioStr.

CUARTA - LEY APLICABLE: Este contrato se rige 铆ntegramente por la LEY 820 DE 2003 y dem谩s normas concordantes del C贸digo Civil Colombiano.

QUINTA - INCREMENTO: Vencido el t茅rmino inicial, el canon se incrementar谩 anualmente de acuerdo al IPC del a帽o inmediatamente anterior.
""";

    // LGICA PARA AGREGAR LAS CLUSULAS OPCIONALES
    int contadorClausulas = 6; // Empezamos en la SEXTA

    if (_clausulaDanos) {
      texto += "\nCLUSULA $contadorClausulas - ESTADO DEL INMUEBLE Y DAOS: El Arrendatario declara haber recibido el inmueble en buen estado y se obliga a restituirlo en las mismas condiciones, salvo el deterioro natural por el uso leg铆timo. Cualquier da帽o locativo o estructural causado por culpa del Arrendatario ser谩 reparado a su costa exclusiva.\n";
      contadorClausulas++;
    }

    if (_clausulaPenal) {
      texto += "\nCLUSULA $contadorClausulas - CLUSULA PENAL: El incumplimiento de cualquiera de las obligaciones por parte del Arrendatario dar谩 derecho al Arrendador al cobro de una suma equivalente a DOS (2) c谩nones de arrendamiento a t铆tulo de pena.\n";
      contadorClausulas++;
    }

    if (_renunciaRequerimientos) {
      texto += "\nCLUSULA $contadorClausulas - RENUNCIA A REQUERIMIENTOS (PROTECCIN): El Arrendatario RENUNCIA EXPRESAMENTE a los requerimientos de que tratan los art铆culos 2007 y 2035 del C贸digo Civil. El Arrendador podr谩 iniciar proceso de restituci贸n inmediatamente se presente mora.\n";
    }

    texto += "\nPara constancia se firma digitalmente a trav茅s de la plataforma BuenVecino.";
    return texto;
  }

  // --- WIDGETS INTERNOS ---
  Widget _buildResumenHeader() {
    return Container(
      padding: const EdgeInsets.all(15),
      decoration: BoxDecoration(color: Colors.blue.shade50, borderRadius: BorderRadius.circular(15), border: Border.all(color: Colors.blue.shade200)),
      child: Row(
        children: [
          const CircleAvatar(backgroundColor: Colors.blue, child: Icon(Icons.person, color: Colors.white)),
          const SizedBox(width: 15),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text("Inquilino Seleccionado:", style: TextStyle(fontSize: 12, color: Colors.blueGrey)),
                Text(widget.nombreInquilino, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
                Text("Canon: ${widget.canon}", style: const TextStyle(color: Colors.blue, fontWeight: FontWeight.bold)),
              ],
            ),
          )
        ],
      ),
    );
  }

  Widget _buildDateSelector(String label, DateTime fecha, Function(DateTime) onSelect) {
    return ListTile(
      title: Text(label, style: const TextStyle(fontWeight: FontWeight.bold)),
      subtitle: Text("${fecha.day}/${fecha.month}/${fecha.year}"),
      trailing: const Icon(Icons.calendar_month, color: Colors.blue),
      onTap: () async {
        final d = await showDatePicker(context: context, initialDate: fecha, firstDate: DateTime.now(), lastDate: DateTime(2030));
        if (d != null) onSelect(d);
      },
    );
  }

  Widget _buildDropdown(String label, int valor, Function(int?) onChange) {
    return ListTile(
      title: Text(label, style: const TextStyle(fontWeight: FontWeight.bold)),
      trailing: DropdownButton<int>(
        value: valor,
        underline: Container(),
        items: const [
          DropdownMenuItem(value: 6, child: Text("6 Meses")),
          DropdownMenuItem(value: 12, child: Text("12 Meses (1 A帽o)")),
          DropdownMenuItem(value: 24, child: Text("24 Meses")),
        ],
        onChanged: onChange,
      ),
    );
  }

  Widget _buildDiaPagoSelector() {
    return ListTile(
      title: const Text("D铆a l铆mite de pago", style: TextStyle(fontWeight: FontWeight.bold)),
      subtitle: Text("Los inquilinos pagar谩n los primeros $_diaPago d铆as del mes"),
      trailing: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          IconButton(icon: const Icon(Icons.remove_circle_outline), onPressed: () => setState(() { if(_diaPago > 1) _diaPago--; })),
          Text("$_diaPago", style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
          IconButton(icon: const Icon(Icons.add_circle_outline), onPressed: () => setState(() { if(_diaPago < 30) _diaPago++; })),
        ],
      ),
    );
  }

  Widget _buildSwitch(String title, String subtitle, bool value, Function(bool) onChange, {bool isVital = false}) {
    return SwitchListTile(
      title: Text(title, style: TextStyle(fontWeight: FontWeight.bold, color: isVital ? Colors.red.shade900 : Colors.black)),
      subtitle: Text(subtitle, style: const TextStyle(fontSize: 12)),
      value: value,
      activeColor: isVital ? Colors.red : Colors.blue,
      onChanged: onChange,
    );
  }
}

// --- 19. PANTALLA VISTA PREVIA (RESULTADO) ---
class PantallaVistaPreviaContrato extends StatelessWidget {
  final String textoContrato;
  const PantallaVistaPreviaContrato({super.key, required this.textoContrato});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text("Vista Previa"), backgroundColor: Colors.white, foregroundColor: Colors.black, elevation: 0),
      body: Padding(
        padding: const EdgeInsets.all(25.0),
        child: Column(
          children: [
            Expanded(
              child: Container(
                width: double.infinity,
                padding: const EdgeInsets.all(20),
                decoration: BoxDecoration(color: Colors.white, border: Border.all(color: Colors.grey.shade300), boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 10)]),
                child: SingleChildScrollView(
                  child: Text(textoContrato, style: const TextStyle(height: 1.6, fontSize: 14, fontFamily: "Courier")),
                ),
              ),
            ),
            const SizedBox(height: 20),
            
            // --- AQU EST EL AJUSTE PARA TU XIAOMI ---
            Padding(
              padding: const EdgeInsets.only(bottom: 30), // <--- Margen inferior para separar del borde
              child: SizedBox(
                width: double.infinity,
                child: ElevatedButton(
                  onPressed: () {
                     // --- AQU GUARDAMOS EL CONTRATO EN EL BUZN COMPARTIDO ---
                     GestorContrato.contratoFinal = textoContrato;
                     
                     showDialog(context: context, builder: (context) => AlertDialog(
                       title: const Text("隆Enviado al Inquilino!"),
                       content: const Text("El contrato ha sido enviado a Elkin B. Ahora 茅l podr谩 verlo en su secci贸n de 'Mis Arriendos'."),
                       actions: [TextButton(onPressed: (){ Navigator.pop(context); Navigator.pop(context); Navigator.pop(context); }, child: const Text("OK"))],
                     ));
                  },
                  style: ElevatedButton.styleFrom(backgroundColor: Colors.green, padding: const EdgeInsets.symmetric(vertical: 15)),
                  child: const Text("APROBAR Y ENVIAR A FIRMA", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
                ),
              ),
            )
          ],
        ),
      ),
    );
  }
}


// -------------------------------------------------------------------------
// 20. WIDGETS AUXILIARES (RESTAURADOS A SU VERSIN COMPLETA)
// -------------------------------------------------------------------------

class _TarjetaVisita extends StatelessWidget {
  final String nombre, inmueble, fecha, hora, mensaje, tiempo;
  final String rating, nivel, mudanzas, pagos;
  const _TarjetaVisita({required this.nombre, required this.inmueble, required this.fecha, required this.hora, required this.mensaje, required this.tiempo, required this.rating, required this.nivel, required this.mudanzas, required this.pagos});
  @override Widget build(BuildContext context) {
    final esOro = nivel.contains("Oro");
    final colorNivel = esOro ? Colors.amber : (nivel.contains("Plata") ? Colors.blueGrey : Colors.blue);
    return Container(margin: const EdgeInsets.only(bottom: 20), decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(20), border: Border.all(color: Colors.blue.shade100, width: 1.5), boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 10, offset: const Offset(0, 5))]), child: Column(children: [Container(padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 10), decoration: BoxDecoration(color: Colors.blue.shade50, borderRadius: const BorderRadius.vertical(top: Radius.circular(18))), child: Row(mainAxisAlignment: MainAxisAlignment.spaceBetween, children: [Row(children: [const Icon(Icons.calendar_today, size: 16, color: Colors.blue), const SizedBox(width: 8), Text("Solicitud de Visita", style: TextStyle(color: Colors.blue.shade800, fontWeight: FontWeight.bold, fontSize: 12))]), Text(tiempo, style: TextStyle(color: Colors.blue.shade300, fontSize: 12))])), Padding(padding: const EdgeInsets.all(20), child: Column(children: [Row(children: [CircleAvatar(radius: 20, backgroundColor: Colors.purple.shade100, child: Text(nombre[0])), const SizedBox(width: 15), Expanded(child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [Text(nombre, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16)), Row(children: [Icon(Icons.star, size: 14, color: colorNivel), const SizedBox(width: 5), Text("$rating - $nivel", style: TextStyle(color: colorNivel, fontSize: 12, fontWeight: FontWeight.bold))]), Text(inmueble, style: const TextStyle(color: Colors.grey, fontSize: 12))]))]), const SizedBox(height: 15), Row(children: [_DatoClave(label: "Estabilidad", valor: mudanzas, icon: Icons.home, color: Colors.blue), const SizedBox(width: 10), _DatoClave(label: "Pagos", valor: pagos, icon: Icons.attach_money, color: Colors.green)]), const SizedBox(height: 15), Container(padding: const EdgeInsets.all(12), decoration: BoxDecoration(color: Colors.grey.shade50, borderRadius: BorderRadius.circular(10)), child: Row(children: [const Icon(Icons.access_time_filled, color: Colors.black87), const SizedBox(width: 15), Text("$fecha - $hora", style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16))])), const SizedBox(height: 20), SizedBox(width: double.infinity, child: ElevatedButton.icon(onPressed: () { showDialog(context: context, builder: (context) => AlertDialog(title: const Text("Ingresar C贸digo"), content: const TextField(textAlign: TextAlign.center, decoration: InputDecoration(hintText: "0000")), actions: [TextButton(onPressed: () => Navigator.pop(context), child: const Text("CANCELAR")), ElevatedButton(onPressed: () => Navigator.pop(context), child: const Text("VALIDAR"))])); }, icon: const Icon(Icons.vpn_key), label: const Text("INGRESAR CDIGO DE VISITA"), style: ElevatedButton.styleFrom(backgroundColor: Colors.amber.shade700, foregroundColor: Colors.white)))]))]));
  }
}

class _TarjetaSolicitud extends StatelessWidget {
  final String nombre, inmueble, mensaje, rating, nivel, tiempo, mudanzas, pagos;
  // Agregamos par谩metros opcionales para evitar errores si no se usan en otro lado
  final List<String> documentosAdjuntos; 
  final List<String> condicionesAceptadas; 
  final bool esIndependiente; 

  const _TarjetaSolicitud({
    required this.nombre, 
    required this.inmueble, 
    required this.mensaje, 
    required this.rating, 
    required this.nivel, 
    required this.tiempo, 
    required this.mudanzas, 
    required this.pagos,
    this.documentosAdjuntos = const [], 
    this.condicionesAceptadas = const [], 
    this.esIndependiente = false
  });
  
  @override 
  Widget build(BuildContext context) {
    // Verificamos firma de forma segura
    bool yaFirmo = GestorContrato.firmaInquilino && nombre.contains("Elkin");
    
    return Card(
      margin: const EdgeInsets.only(bottom: 20), 
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15)), 
      elevation: 3, 
      child: Padding(
        padding: const EdgeInsets.all(15), 
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start, 
          children: [
            // Encabezado
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween, 
              children: [
                Text(nombre, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16)), 
                Text(tiempo, style: const TextStyle(color: Colors.grey, fontSize: 12))
              ]
            ),
            Text("$rating - $nivel", style: const TextStyle(color: Colors.orange, fontWeight: FontWeight.bold, fontSize: 12)),
            Text(inmueble, style: const TextStyle(color: Colors.grey)),
            const SizedBox(height: 10),
            Text(mensaje, style: const TextStyle(fontStyle: FontStyle.italic)),
            const SizedBox(height: 15),
            
            // --- LGICA DEL BOTN ---
            if (yaFirmo) 
              SizedBox(
                width: double.infinity,
                child: ElevatedButton.icon(
                  onPressed: () async {
                    // Generar PDF para el Propietario
                    final pdf = pw.Document();
                    pdf.addPage(pw.Page(build: (format) => pw.Column(children: [
                      pw.Header(level: 0, child: pw.Text("CONTRATO DE ARRENDAMIENTO", style: pw.TextStyle(fontWeight: pw.FontWeight.bold, fontSize: 20))),
                      pw.SizedBox(height: 20),
                      pw.Text(GestorContrato.contratoFinal ?? "Contrato Generado"),
                      pw.SizedBox(height: 40),
                      pw.Divider(),
                      pw.Text("Firmado digitalmente el ${DateTime.now().toString()}", style: pw.TextStyle(color: PdfColors.green, fontWeight: pw.FontWeight.bold)),
                      pw.Container(
                        margin: const pw.EdgeInsets.only(top: 10),
                        padding: const pw.EdgeInsets.all(10),
                        decoration: pw.BoxDecoration(border: pw.Border.all(color: PdfColors.black)),
                        child: pw.Text("[Firma Digital Capturada de $nombre]")
                      )
                    ])));

                    await Printing.layoutPdf(onLayout: (format) async => pdf.save(), name: 'Contrato_Firmado_$nombre.pdf');
                  },
                  icon: const Icon(Icons.download),
                  label: const Text("VER Y DESCARGAR PDF"),
                  style: ElevatedButton.styleFrom(backgroundColor: Colors.green.shade700, foregroundColor: Colors.white, padding: const EdgeInsets.symmetric(vertical: 12)),
                ),
              )
            else 
              Row(
                children: [
                  Expanded(
                    child: OutlinedButton(
                      onPressed: (){}, 
                      style: OutlinedButton.styleFrom(foregroundColor: Colors.red), 
                      child: const Text("Rechazar")
                    )
                  ),
                  const SizedBox(width: 10),
                  Expanded(
                    child: ElevatedButton(
                      onPressed: () => Navigator.push(context, MaterialPageRoute(builder: (c) => PantallaConfigurarContrato(nombreInquilino: nombre, nombrePropietario: "Juan Perez", inmueble: inmueble, canon: "\$1.200.000"))), 
                      style: ElevatedButton.styleFrom(backgroundColor: Colors.green, foregroundColor: Colors.white), 
                      child: const Text("APROBAR")
                    )
                  )
                ]
              )
          ]
        )
      )
    );
  }
}

class _TarjetaInmueble extends StatelessWidget { 
  final String titulo, precio, ubicacion, imagenUrl, dueno, rating, descripcion; 
  final List<String> comodidades; final List<String> requisitos; final String? valorDeposito; final String? nivelArrendador;
  const _TarjetaInmueble({required this.titulo, required this.precio, required this.ubicacion, required this.imagenUrl, required this.dueno, required this.rating, required this.descripcion, required this.comodidades, required this.requisitos, this.valorDeposito, this.nivelArrendador}); 
  @override Widget build(BuildContext context) { return GestureDetector(onTap: () => Navigator.push(context, MaterialPageRoute(builder: (c) => PantallaDetalle(titulo: titulo, precio: precio, ubicacion: ubicacion, imagenUrl: imagenUrl, dueno: dueno, rating: rating, descripcion: descripcion, comodidades: comodidades, requisitos: requisitos, valorDeposito: valorDeposito, nivelArrendador: nivelArrendador ?? ""))), child: Container(margin: const EdgeInsets.only(bottom: 25), decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(20), boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.08), blurRadius: 15, offset: const Offset(0, 5))]), child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [ClipRRect(borderRadius: const BorderRadius.vertical(top: Radius.circular(20)), child: Image.network(imagenUrl, height: 200, width: double.infinity, fit: BoxFit.cover, errorBuilder: (context, error, stackTrace) => Container(height: 200, color: Colors.grey.shade200))), Padding(padding: const EdgeInsets.all(15.0), child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [Row(mainAxisAlignment: MainAxisAlignment.spaceBetween, children: [Text(precio, style: const TextStyle(fontSize: 18, fontWeight: FontWeight.w900, color: Colors.blue)), Container(padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4), decoration: BoxDecoration(color: Colors.amber.shade50, borderRadius: BorderRadius.circular(8), border: Border.all(color: Colors.amber.shade200)), child: Row(children: [const Icon(Icons.star, size: 14, color: Colors.amber), const SizedBox(width: 4), Text("$rating ($dueno)", style: TextStyle(fontSize: 12, fontWeight: FontWeight.bold, color: Colors.amber.shade900))]))]), const SizedBox(height: 5), Text(titulo, style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold)), const SizedBox(height: 5), Row(children: [const Icon(Icons.location_on, size: 14, color: Colors.grey), const SizedBox(width: 4), Text(ubicacion, style: const TextStyle(fontSize: 14, color: Colors.grey))])]))]))); } 
}


// 21. PANTALLA LISTA DE CHATS (ACTUALIZADA CON ELKIN Y MARA) ---
class PantallaListaChats extends StatelessWidget {
  final bool esVistaPropietario; // Esto es el "cerebro" que decide qu茅 mostrar

  const PantallaListaChats({super.key, this.esVistaPropietario = false});

  @override
  Widget build(BuildContext context) {
    // Si esVistaPropietario es TRUE, mostramos a Elkin y Mar铆a
    final listaChats = esVistaPropietario
      ? [
          _chatItem(context, "Elkin B", "Hola, me interesa el apto de Chapinero", "10:30 AM", true),
          _chatItem(context, "Mar铆a", "Ya envi茅 los documentos para el estudio", "09:15 AM", true),
          _chatItem(context, "Pedro Inquilino", "驴Aceptan mascotas?", "Ayer", false),
        ]
      : [
          _chatItem(context, "Juan Propietario", "Quedo atento a tu respuesta", "11:00 AM", true),
          _chatItem(context, "Soporte BuenVecino", "Bienvenido a la app", "Ayer", false),
        ];

    return Scaffold(
      appBar: AppBar(
        title: Text(esVistaPropietario ? "Bandeja de Entrada" : "Mis Chats"),
        backgroundColor: Colors.white,
        foregroundColor: Colors.black,
        elevation: 1,
      ),
      body: ListView(padding: const EdgeInsets.all(10), children: listaChats),
    );
  }

  Widget _chatItem(BuildContext context, String nombre, String mensaje, String hora, bool noLeido) {
    return ListTile(
      onTap: () {
        // Al tocar, vamos al chat individual
        Navigator.push(context, MaterialPageRoute(builder: (c) => PantallaChatDetalle(nombre: nombre)));
      },
      leading: CircleAvatar(
        backgroundColor: noLeido ? Colors.blue.shade100 : Colors.grey.shade200,
        child: Text(nombre[0], style: TextStyle(color: noLeido ? Colors.blue.shade900 : Colors.black)),
      ),
      title: Text(nombre, style: TextStyle(fontWeight: noLeido ? FontWeight.bold : FontWeight.normal)),
      subtitle: Text(mensaje, maxLines: 1, overflow: TextOverflow.ellipsis),
      trailing: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Text(hora, style: const TextStyle(fontSize: 12, color: Colors.grey)),
          if (noLeido) Container(margin: const EdgeInsets.only(top: 5), width: 10, height: 10, decoration: const BoxDecoration(color: Colors.blue, shape: BoxShape.circle))
        ],
      ),
    );
  }
}


// 22. PANTALLA DETALLE CHAT (CON MS ESPACIO INFERIOR) ---
class PantallaChatDetalle extends StatefulWidget {
  final String nombre;
  const PantallaChatDetalle({super.key, required this.nombre});

  @override
  State<PantallaChatDetalle> createState() => _PantallaChatDetalleState();
}

class _PantallaChatDetalleState extends State<PantallaChatDetalle> {
  final TextEditingController _controller = TextEditingController();
  final ScrollController _scrollController = ScrollController(); 
  
  final List<Map<String, dynamic>> _mensajes = [
    {"texto": "Hola, estoy interesado en el inmueble.", "esMio": true},
    {"texto": "隆Hola! Claro que s铆, sigue disponible.", "esMio": false},
    {"texto": "驴Cu谩ndo podr铆a ir a verlo?", "esMio": true},
  ];

  void _enviarMensaje() {
    if (_controller.text.isEmpty) return;
    
    setState(() {
      _mensajes.add({"texto": _controller.text, "esMio": true});
    });
    _controller.clear();
    _bajarAlFinal();

    // Simulamos respuesta autom谩tica
    Future.delayed(const Duration(seconds: 2), () {
      if (mounted) {
        setState(() {
          _mensajes.add({"texto": "隆Perfecto! Revisa la agenda en la app para separar tu cita.", "esMio": false});
        });
        _bajarAlFinal();

        // Notificaci贸n emergente (SnackBar)
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                const Icon(Icons.notifications_active, color: Colors.white),
                const SizedBox(width: 15),
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Text("Nuevo mensaje de ${widget.nombre}", style: const TextStyle(fontWeight: FontWeight.bold)),
                    const Text("隆Perfecto! Revisa la agenda...", style: TextStyle(fontSize: 10)),
                  ],
                ),
              ],
            ),
            backgroundColor: const Color(0xFF2C3E50), 
            behavior: SnackBarBehavior.floating, 
            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
            margin: const EdgeInsets.all(20),
            duration: const Duration(seconds: 3),
          )
        );
      }
    });
  }

  void _bajarAlFinal() {
    Future.delayed(const Duration(milliseconds: 100), () {
      if (_scrollController.hasClients) {
        _scrollController.animateTo(
          _scrollController.position.maxScrollExtent,
          duration: const Duration(milliseconds: 300),
          curve: Curves.easeOut,
        );
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        backgroundColor: Colors.white,
        elevation: 1,
        foregroundColor: Colors.black,
        title: Row(children: [
          CircleAvatar(radius: 18, backgroundColor: Colors.blue.shade100, child: Text(widget.nombre[0])),
          const SizedBox(width: 10),
          Expanded(child: Text(widget.nombre, style: const TextStyle(fontSize: 16)))
        ]),
        actions: [IconButton(icon: const Icon(Icons.phone), onPressed: (){}), IconButton(icon: const Icon(Icons.more_vert), onPressed: (){})],
      ),
      body: Column(
        children: [
          Expanded(
            child: ListView.builder(
              controller: _scrollController, 
              padding: const EdgeInsets.all(20),
              itemCount: _mensajes.length,
              itemBuilder: (context, index) {
                final msg = _mensajes[index];
                final esMio = msg['esMio'];
                return Align(
                  alignment: esMio ? Alignment.centerRight : Alignment.centerLeft,
                  child: Container(
                    margin: const EdgeInsets.only(bottom: 10),
                    padding: const EdgeInsets.symmetric(horizontal: 15, vertical: 10),
                    constraints: BoxConstraints(maxWidth: MediaQuery.of(context).size.width * 0.7),
                    decoration: BoxDecoration(
                      color: esMio ? const Color(0xFFDCF8C6) : Colors.white,
                      borderRadius: BorderRadius.only(
                        topLeft: const Radius.circular(15),
                        topRight: const Radius.circular(15),
                        bottomLeft: esMio ? const Radius.circular(15) : Radius.zero,
                        bottomRight: esMio ? Radius.zero : const Radius.circular(15)
                      ),
                      boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)]
                    ),
                    child: Text(msg['texto'], style: const TextStyle(fontSize: 15)),
                  ),
                );
              },
            ),
          ),
          
          // --- ZONA DE ESCRIBIR (MS ARRIBA AN) ---
          Container(
            // AQU EST EL CAMBIO: padding bottom subi贸 a 55
            padding: const EdgeInsets.fromLTRB(10, 10, 10, 55), 
            color: Colors.white,
            child: Row(
              children: [
                Expanded(
                  child: Container(
                    padding: const EdgeInsets.symmetric(horizontal: 15),
                    decoration: BoxDecoration(color: Colors.grey.shade100, borderRadius: BorderRadius.circular(25)),
                    child: TextField(
                      controller: _controller,
                      decoration: const InputDecoration(hintText: "Escribe un mensaje...", border: InputBorder.none),
                      onSubmitted: (_) => _enviarMensaje(), 
                    ),
                  ),
                ),
                const SizedBox(width: 10),
                CircleAvatar(
                  backgroundColor: const Color(0xFF2C3E50),
                  child: IconButton(icon: const Icon(Icons.send, color: Colors.white, size: 20), onPressed: _enviarMensaje),
                )
              ],
            ),
          )
        ],
      ),
    );
  }
}


// 23. PANTALLA PRINCIPAL DEL INVENTARIO
class PantallaInventario extends StatefulWidget {
  const PantallaInventario({super.key});

  @override
  State<PantallaInventario> createState() => _PantallaInventarioState();
}

class _PantallaInventarioState extends State<PantallaInventario> {
  // Lista de items a revisar
  final List<Map<String, dynamic>> _items = [
    {"nombre": "Pintura y Paredes", "icono": Icons.format_paint, "estado": "ok", "foto": false, "analisis": null},
    {"nombre": "Pisos y Guardescobas", "icono": Icons.grid_view, "estado": "ok", "foto": false, "analisis": null},
    {"nombre": "Estufa y Horno", "icono": Icons.kitchen, "estado": "ok", "foto": false, "analisis": null},
    {"nombre": "Grifer铆a y Ba帽os", "icono": Icons.water_drop, "estado": "ok", "foto": false, "analisis": null},
    {"nombre": "Cerraduras y Llaves", "icono": Icons.vpn_key, "estado": "ok", "foto": false, "analisis": null},
  ];

  // SIMULACIN DE IA (Visi贸n Computarizada)
  void _analizarFotoConIA(int index) async {
    // 1. Mostrar Esc谩ner Futurista
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) {
        return Dialog(
          backgroundColor: Colors.transparent,
          elevation: 0,
          child: Container(
            padding: const EdgeInsets.all(20),
            decoration: BoxDecoration(
              color: Colors.black.withOpacity(0.85),
              borderRadius: BorderRadius.circular(20),
              border: Border.all(color: Colors.cyanAccent, width: 1)
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                const CircularProgressIndicator(color: Colors.cyanAccent),
                const SizedBox(height: 20),
                const Text("ANALIZANDO IMAGEN...", style: TextStyle(color: Colors.cyanAccent, fontFamily: "Courier", fontWeight: FontWeight.bold)),
                const SizedBox(height: 10),
                const Text("Detectando grietas...", style: TextStyle(color: Colors.white70, fontSize: 10)),
                const Text("Calculando humedad...", style: TextStyle(color: Colors.white70, fontSize: 10)),
              ],
            ),
          ),
        );
      },
    );

    // 2. Esperar simulaci贸n
    await Future.delayed(const Duration(seconds: 3));

    if (mounted) {
      Navigator.pop(context); // Cerrar esc谩ner

      // 3. Resultado de la IA
      setState(() {
        _items[index]['foto'] = true;
        // Generamos un reporte autom谩tico "inteligente"
        _items[index]['analisis'] = " IA DETECT: Desgaste severo en zona inferior. Posible humedad filtrada.";
      });

      // 4. Feedback visual
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          backgroundColor: Colors.cyan.shade900,
          content: Row(
            children: const [
              Icon(Icons.auto_awesome, color: Colors.cyanAccent),
              SizedBox(width: 10),
              Expanded(child: Text("An谩lisis completado. Da帽o registrado.")),
            ],
          )
        )
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.grey.shade50,
      appBar: AppBar(
        title: const Text("Acta de Entrega ", style: TextStyle(color: Colors.black, fontWeight: FontWeight.bold)),
        backgroundColor: Colors.white,
        elevation: 0,
        leading: const BackButton(color: Colors.black),
      ),
      body: Column(
        children: [
          // Cabecera Informativa
          Container(
            padding: const EdgeInsets.all(20),
            color: Colors.white,
            child: Column(
              children: [
                Row(
                  children: [
                    Container(
                      padding: const EdgeInsets.all(8),
                      decoration: BoxDecoration(color: Colors.purple.shade50, borderRadius: BorderRadius.circular(8)),
                      child: const Icon(Icons.auto_awesome, color: Colors.purple),
                    ),
                    const SizedBox(width: 15),
                    const Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text("Inventario Asistido por IA", style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                          Text("Nuestra IA detecta da帽os en las fotos autom谩ticamente.", style: TextStyle(color: Colors.grey, fontSize: 12)),
                        ],
                      ),
                    )
                  ],
                ),
                const SizedBox(height: 15),
                LinearProgressIndicator(value: 1.0, backgroundColor: Colors.grey.shade200, color: Colors.purple, minHeight: 6, borderRadius: BorderRadius.circular(5)),
              ],
            ),
          ),

          // Lista de Items
          Expanded(
            child: ListView.builder(
              padding: const EdgeInsets.all(20),
              itemCount: _items.length,
              itemBuilder: (context, index) {
                final item = _items[index];
                bool estaOk = item['estado'] == "ok";
                bool tieneFoto = item['foto'];
                String? analisisIA = item['analisis'];

                return Container(
                  margin: const EdgeInsets.only(bottom: 15),
                  padding: const EdgeInsets.all(15),
                  decoration: BoxDecoration(
                    color: Colors.white, 
                    borderRadius: BorderRadius.circular(15), 
                    border: Border.all(color: estaOk ? Colors.grey.shade200 : Colors.red.shade100, width: estaOk ? 1 : 2),
                    boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.03), blurRadius: 5)]
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          Container(padding: const EdgeInsets.all(10), decoration: BoxDecoration(color: Colors.blue.shade50, shape: BoxShape.circle), child: Icon(item['icono'], color: Colors.blue, size: 20)),
                          const SizedBox(width: 15),
                          Expanded(child: Text(item['nombre'], style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16))),
                        ],
                      ),
                      const Divider(height: 25),
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          // Selector de Estado
                          Row(
                            children: [
                              GestureDetector(
                                onTap: () => setState(() { item['estado'] = "ok"; item['analisis'] = null; }),
                                child: Container(
                                  padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                                  decoration: BoxDecoration(color: estaOk ? Colors.green.shade100 : Colors.grey.shade100, borderRadius: BorderRadius.circular(20)),
                                  child: Row(children: [Icon(Icons.check_circle, size: 16, color: estaOk ? Colors.green : Colors.grey), const SizedBox(width: 5), Text("Ok", style: TextStyle(fontSize: 12, fontWeight: FontWeight.bold, color: estaOk ? Colors.green.shade800 : Colors.grey))]),
                                ),
                              ),
                              const SizedBox(width: 10),
                              GestureDetector(
                                onTap: () => setState(() => item['estado'] = "da帽o"),
                                child: Container(
                                  padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                                  decoration: BoxDecoration(color: !estaOk ? Colors.red.shade100 : Colors.grey.shade100, borderRadius: BorderRadius.circular(20)),
                                  child: Row(children: [Icon(Icons.warning, size: 16, color: !estaOk ? Colors.red : Colors.grey), const SizedBox(width: 5), Text("Da帽o", style: TextStyle(fontSize: 12, fontWeight: FontWeight.bold, color: !estaOk ? Colors.red.shade900 : Colors.grey))]),
                                ),
                              ),
                            ],
                          ),
                          
                          // Bot贸n Foto IA (Solo si hay da帽o)
                          if (!estaOk)
                            ElevatedButton.icon(
                              onPressed: () => _analizarFotoConIA(index),
                              icon: Icon(tieneFoto ? Icons.auto_awesome : Icons.camera_alt, size: 16, color: Colors.white),
                              label: Text(tieneFoto ? "Re-Escanear" : "Escanear con IA", style: const TextStyle(fontSize: 10)),
                              style: ElevatedButton.styleFrom(
                                backgroundColor: tieneFoto ? Colors.black87 : Colors.blue,
                                foregroundColor: Colors.white,
                                padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 5)
                              ),
                            )
                        ],
                      ),

                      // RESULTADO DE LA IA
                      if (analisisIA != null)
                        Container(
                          margin: const EdgeInsets.only(top: 15),
                          padding: const EdgeInsets.all(10),
                          width: double.infinity,
                          decoration: BoxDecoration(
                            color: Colors.grey.shade50,
                            borderRadius: BorderRadius.circular(10),
                            border: Border.all(color: Colors.grey.shade300)
                          ),
                          child: Row(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              const Icon(Icons.auto_awesome, size: 16, color: Colors.purple),
                              const SizedBox(width: 8),
                              Expanded(child: Text(analisisIA, style: const TextStyle(fontSize: 12, color: Colors.black87, fontStyle: FontStyle.italic))),
                            ],
                          ),
                        )
                    ],
                  ),
                );
              },
            ),
          ),

          // Bot贸n Final
          Container(
            padding: const EdgeInsets.fromLTRB(20, 20, 20, 60),
            decoration: BoxDecoration(color: Colors.white, boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.05), blurRadius: 10, offset: const Offset(0, -5))]),
            child: SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                onPressed: () async {
                  // Guardamos en el Gestor
                  GestorInventario.inventarioFirmado = true;
                  GestorInventario.fechaFirma = DateTime.now();

                  showDialog(
                    context: context, 
                    builder: (context) => AlertDialog(
                      icon: const Icon(Icons.mark_email_read, size: 50, color: Colors.blue),
                      title: const Text("隆Reporte IA Enviado!"),
                      content: const Text("El inventario y el an谩lisis fotogr谩fico han sido enviados al propietario."),
                      actions: [
                        TextButton(
                          onPressed: (){ 
                            Navigator.pop(context); 
                            Navigator.pop(context); 
                          }, 
                          child: const Text("FINALIZAR")
                        )
                      ],
                    )
                  );
                },
                style: ElevatedButton.styleFrom(backgroundColor: const Color(0xFF2C3E50), padding: const EdgeInsets.symmetric(vertical: 18), shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15))),
                child: const Text("FIRMAR Y RECIBIR INMUEBLE", style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold)),
              ),
            ),
          )
        ],
      ),
    );
  }
}

// ============================================================================
//  24. PANTALLA NOTIFICACIN PROPIETARIO (BUZN DE ENTREGA)
// ============================================================================
class PantallaConfirmacionPropietario extends StatelessWidget {
  const PantallaConfirmacionPropietario({super.key});

  @override
  Widget build(BuildContext context) {
    bool firmado = GestorInventario.inventarioFirmado;

    return Scaffold(
      appBar: AppBar(title: const Text("Mis Notificaciones"), backgroundColor: Colors.white, foregroundColor: Colors.black, elevation: 0),
      body: Center(
        child: firmado 
        ? Container(
            margin: const EdgeInsets.all(20),
            padding: const EdgeInsets.all(25),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(20),
              boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.1), blurRadius: 15, offset: const Offset(0, 5))]
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                const Icon(Icons.verified_user, size: 60, color: Colors.green),
                const SizedBox(height: 20),
                const Text("隆Inmueble Entregado!", style: TextStyle(fontSize: 22, fontWeight: FontWeight.bold)),
                const SizedBox(height: 10),
                Text("El inquilino ha firmado el Acta de Entrega el d铆a:\n${GestorInventario.fechaFirma.toString().split('.')[0]}", textAlign: TextAlign.center, style: const TextStyle(color: Colors.grey)),
                const SizedBox(height: 20),
                const Divider(),
                
                // --- TARJETA DE ARCHIVO ADJUNTO (CLICKABLE) ---
                ListTile(
                  leading: const Icon(Icons.picture_as_pdf, color: Colors.red, size: 40),
                  title: const Text("Acta_Entrega_Final.pdf", style: TextStyle(fontWeight: FontWeight.bold)),
                  subtitle: const Text("Documento Legal Firmado  2.5 MB\nToca para ver soporte", style: TextStyle(fontSize: 12)),
                  trailing: const Icon(Icons.arrow_forward_ios, size: 14, color: Colors.grey),
                  onTap: () {
                    // CONEXIN: Abre el visor del documento (Secci贸n 25)
                    Navigator.push(context, MaterialPageRoute(builder: (context) => const PantallaSoporteLegal()));
                  }, 
                ),
                // ----------------------------------------------

                const SizedBox(height: 20),
                ElevatedButton(onPressed: () => Navigator.pop(context), style: ElevatedButton.styleFrom(backgroundColor: Colors.black), child: const Text("ENTENDIDO"))
              ],
            ),
          )
        : Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(Icons.access_time, size: 60, color: Colors.grey.shade300),
              const SizedBox(height: 20),
              const Text("Sin novedades", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: Colors.grey)),
              const Text("El inquilino a煤n no ha firmado el acta.", style: TextStyle(color: Colors.grey)),
            ],
          ),
      ),
    );
  }
}

// ============================================================================
//  25. PANTALLA SOPORTE LEGAL (VISOR DEL PDF + DESCARGAR)
// ============================================================================
class PantallaSoporteLegal extends StatelessWidget {
  const PantallaSoporteLegal({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: const Color(0xFF525659), // Fondo gris oscuro profesional
      appBar: AppBar(
        title: const Text("Acta_Final_Firmada.pdf", style: TextStyle(fontSize: 14)),
        backgroundColor: Colors.black,
        foregroundColor: Colors.white,
        actions: [
          IconButton(
            icon: const Icon(Icons.download), 
            onPressed: () {
              ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("猬锔 Descargando archivo al dispositivo...")));
            }
          ),
          IconButton(
            icon: const Icon(Icons.share), 
            onPressed: () {
              ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text(" Compartiendo documento...")));
            }
          ),
        ],
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Center(
          child: Container(
            // --- ESTO SIMULA LA HOJA DE PAPEL ---
            width: double.infinity,
            constraints: const BoxConstraints(maxWidth: 500),
            padding: const EdgeInsets.all(40),
            decoration: BoxDecoration(color: Colors.white, boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.5), blurRadius: 10)]),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // Cabecera Documento
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    const Icon(Icons.apartment, size: 40, color: Colors.black),
                    Column(crossAxisAlignment: CrossAxisAlignment.end, children: [Text("REF: ACTA-2026-001", style: TextStyle(fontSize: 10, color: Colors.grey.shade600)), Text("Generado: ${DateTime.now().toString().substring(0, 10)}", style: TextStyle(fontSize: 10, color: Colors.grey.shade600))])
                  ],
                ),
                const SizedBox(height: 20),
                const Center(child: Text("ACTA DE ENTREGA DE INMUEBLE", style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16, decoration: TextDecoration.underline))),
                const SizedBox(height: 30),
                
                // Texto Legal
                const Text(
                  "En la ciudad de Bogot谩, se hace entrega formal del inmueble ubicado en el Edificio Centenario, Apto 402.",
                  textAlign: TextAlign.justify,
                  style: TextStyle(fontSize: 12, height: 1.5),
                ),
                const SizedBox(height: 20),
                
                // Tabla de Inventario (Resumen)
                const Text("ESTADO DEL INVENTARIO:", style: TextStyle(fontWeight: FontWeight.bold, fontSize: 12)),
                const SizedBox(height: 10),
                Container(
                  decoration: BoxDecoration(border: Border.all(color: Colors.black)),
                  child: Column(
                    children: [
                      _FilaTabla("Pintura y Paredes", "OK"),
                      _FilaTabla("Pisos", "CON DAO (Foto #1)"), // Simulamos el da帽o
                      _FilaTabla("Estufa", "OK"),
                      _FilaTabla("Ba帽os", "OK"),
                      _FilaTabla("Llaves", "OK"),
                    ],
                  ),
                ),
                
                const SizedBox(height: 30),
                
                // Firmas
                const Text("FIRMADO DIGITALMENTE POR:", style: TextStyle(fontWeight: FontWeight.bold, fontSize: 12)),
                const SizedBox(height: 10),
                
                // Firma Inquilino
                Container(
                  padding: const EdgeInsets.all(10),
                  decoration: BoxDecoration(color: Colors.grey.shade100, border: Border.all(color: Colors.grey.shade300), borderRadius: BorderRadius.circular(5)),
                  child: Row(
                    children: [
                      const Icon(Icons.fingerprint, color: Colors.blue, size: 30),
                      const SizedBox(width: 10),
                      const Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text("ELKIN B.", style: TextStyle(fontFamily: "Courier", fontWeight: FontWeight.bold)),
                          Text("CC. 1.098.***.***", style: TextStyle(fontSize: 10)),
                          Text("Firmado desde App Chasis", style: TextStyle(fontSize: 8, color: Colors.grey)),
                        ],
                      )
                    ],
                  ),
                ),
                
                const SizedBox(height: 50),
                
                // Sello de Seguridad
                Center(
                  child: Column(
                    children: [
                      Icon(Icons.qr_code_2, size: 60, color: Colors.grey.shade800),
                      Text("ID DE SEGURIDAD: ${DateTime.now().millisecondsSinceEpoch}", style: const TextStyle(fontSize: 8))
                    ],
                  ),
                )
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _FilaTabla(String item, String estado) {
    return Container(
      padding: const EdgeInsets.all(8),
      decoration: BoxDecoration(border: Border(bottom: BorderSide(color: Colors.grey.shade300))),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(item, style: const TextStyle(fontSize: 11)),
          Text(estado, style: TextStyle(fontSize: 11, fontWeight: FontWeight.bold, color: estado == "OK" ? Colors.black : Colors.red)),
        ],
      ),
    );
  }
}

// ============================================================================
//  26. MDULO DE MANTENIMIENTO (VISTA INQUILINO - FINAL SIN ERRORES)
// ============================================================================
class PantallaMantenimiento extends StatefulWidget {
  const PantallaMantenimiento({super.key});

  @override
  State<PantallaMantenimiento> createState() => _PantallaMantenimientoState();
}

class _PantallaMantenimientoState extends State<PantallaMantenimiento> {
  @override
  Widget build(BuildContext context) {
    // Leemos la lista compartida
    final listaTickets = GestorReparaciones.tickets;

    return Scaffold(
      backgroundColor: Colors.grey.shade50,
      appBar: AppBar(
        title: const Text("Mantenimiento 锔", style: TextStyle(color: Colors.black, fontWeight: FontWeight.bold)),
        backgroundColor: Colors.white,
        elevation: 0,
        leading: const BackButton(color: Colors.black),
      ),
      body: listaTickets.isEmpty 
        ? Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(Icons.check_circle_outline, size: 80, color: Colors.grey.shade300),
                const SizedBox(height: 20),
                const Text("Todo funciona bien", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: Colors.grey)),
                const Text("No tienes reportes activos", style: TextStyle(color: Colors.grey)),
              ],
            ),
          )
        : ListView.builder(
            padding: const EdgeInsets.all(20),
            itemCount: listaTickets.length,
            itemBuilder: (context, index) {
              final reporte = listaTickets[index];
              return Container(
                margin: const EdgeInsets.only(bottom: 15),
                padding: const EdgeInsets.all(15),
                decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(15), boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.05), blurRadius: 10)]),
                child: Row(
                  children: [
                    Container(
                      padding: const EdgeInsets.all(12),
                      decoration: BoxDecoration(color: (reporte['color'] as Color).withOpacity(0.1), shape: BoxShape.circle),
                      child: Icon(Icons.build, color: reporte['color']),
                    ),
                    const SizedBox(width: 15),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(reporte['titulo'], style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
                          const SizedBox(height: 5),
                          Text("${reporte['categoria']}  ${reporte['fecha']}", style: const TextStyle(color: Colors.grey, fontSize: 12)),
                        ],
                      ),
                    ),
                    Container(
                      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 5),
                      decoration: BoxDecoration(color: (reporte['color'] as Color).withOpacity(0.1), borderRadius: BorderRadius.circular(10)),
                      child: Text(reporte['estado'], style: TextStyle(color: reporte['color'], fontWeight: FontWeight.bold, fontSize: 11)),
                    )
                  ],
                ),
              );
            },
          ),
      floatingActionButton: FloatingActionButton.extended(
        onPressed: () {
          // Navega a la pantalla de crear reporte (CON IA)
          Navigator.push(context, MaterialPageRoute(builder: (context) => const PantallaCrearReporte()));
        },
        backgroundColor: const Color(0xFF2C3E50),
        icon: const Icon(Icons.add, color: Colors.white),
        label: const Text("NUEVO REPORTE", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
      ),
    );
  }
}

// --- PANTALLA CREAR REPORTE (CON BOTN REACTIVO Y CORRECCIN DE UNUSED FIELD) ---
class PantallaCrearReporte extends StatefulWidget {
  const PantallaCrearReporte({super.key});

  @override
  State<PantallaCrearReporte> createState() => _PantallaCrearReporteState();
}

class _PantallaCrearReporteState extends State<PantallaCrearReporte> {
  // Controladores y Variables
  final TextEditingController _tituloCtrl = TextEditingController();
  final TextEditingController _descCtrl = TextEditingController();

  String _categoriaSeleccionada = "Fontaner铆a";
  String _urgencia = "Media";
  bool _iaUtilizada = false;
  bool _procesandoIA = false;
  
  // Variable para guardar la foto capturada
  File? _fotoTomada;

  // Lista de categor铆as
  final List<String> _categorias = [
    "Fontaner铆a",
    "Electricidad",
    "Gas",
    "Paredes",
    "Pisos",
    "Electrodom茅sticos",
    "Otros"
  ];

  // --- LGICA DE LA IA CON CMARA REAL ---
  void _activarCamaraIA() async {
    // 1. ABRIR LA CMARA REAL
    final ImagePicker picker = ImagePicker();
    final XFile? imagen = await picker.pickImage(source: ImageSource.camera);

    // Si el usuario cancela la foto, salimos
    if (imagen == null) return;

    setState(() {
      _fotoTomada = File(imagen.path);
      _procesandoIA = true;
    });

    // 2. Mostrar Di谩logo de Esc谩ner Futurista
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) {
        return Dialog(
          backgroundColor: Colors.transparent,
          elevation: 0,
          child: Container(
            height: 380,
            padding: const EdgeInsets.all(20),
            decoration: BoxDecoration(
                color: Colors.black.withOpacity(0.9),
                borderRadius: BorderRadius.circular(20),
                border: Border.all(color: Colors.cyanAccent, width: 2),
                boxShadow: [
                  BoxShadow(color: Colors.cyanAccent.withOpacity(0.2), blurRadius: 20, spreadRadius: 5)
                ]),
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                // Vista previa de la foto tomada dentro del esc谩ner
                ClipRRect(
                  borderRadius: BorderRadius.circular(10),
                  child: Image.file(_fotoTomada!, height: 120, width: 120, fit: BoxFit.cover),
                ),
                const SizedBox(height: 20),
                const LinearProgressIndicator(color: Colors.cyanAccent, backgroundColor: Colors.white10),
                const SizedBox(height: 20),
                Text(
                  "ANALIZANDO ${_categoriaSeleccionada.toUpperCase()}...",
                  style: const TextStyle(color: Colors.cyanAccent, fontFamily: "Courier", fontWeight: FontWeight.bold)
                ),
                const SizedBox(height: 10),
                const Text(
                  "Identificando patrones de da帽o...\nGenerando reporte t茅cnico...",
                  textAlign: TextAlign.center,
                  style: TextStyle(color: Colors.white70, fontSize: 12)
                ),
              ],
            ),
          ),
        );
      },
    );

    // 3. Simular procesamiento de IA
    await Future.delayed(const Duration(seconds: 3));

    if (!mounted) return;
    Navigator.pop(context); // Cerrar el di谩logo

    // 4. Generar el Texto T茅cnico basado en la foto/categor铆a
    String resultadoIA = "";
    switch (_categoriaSeleccionada) {
      case "Fontaner铆a":
        resultadoIA = "Detecci贸n IA: Fuga visible en junta de PVC. Signos de corrosi贸n y humedad. Requiere sellado urgente.";
        break;
      case "Electricidad":
        resultadoIA = "Detecci贸n IA: El cableado muestra signos de sobrecalentamiento. Posible cortocircuito detectado.";
        break;
      default:
        resultadoIA = "Detecci贸n IA: Anomal铆a detectada en $_categoriaSeleccionada. Se recomienda revisi贸n t茅cnica.";
    }

    // 5. Actualizar la interfaz
    setState(() {
      _descCtrl.text = resultadoIA;
      _tituloCtrl.text = "Falla detectada en $_categoriaSeleccionada";
      _iaUtilizada = true;
      _procesandoIA = false;
    });

    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text("Diagn贸stico IA completado"), backgroundColor: Colors.cyan)
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(title: const Text("Reportar Da帽o"), backgroundColor: Colors.white, foregroundColor: Colors.black, elevation: 0),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Text("驴Qu茅 est谩 fallando?", style: TextStyle(fontSize: 22, fontWeight: FontWeight.bold)),
            const SizedBox(height: 20),

            // Selector de Categor铆a
            const Text("Categor铆a", style: TextStyle(fontWeight: FontWeight.bold)),
            const SizedBox(height: 10),
            Wrap(
              spacing: 10,
              runSpacing: 10,
              children: _categorias.map((cat) {
                bool isSelected = _categoriaSeleccionada == cat;
                return ChoiceChip(
                  label: Text(cat),
                  selected: isSelected,
                  onSelected: (val) => setState(() => _categoriaSeleccionada = cat),
                );
              }).toList(),
            ),
            const SizedBox(height: 30),

            // Bot贸n de Escaneo IA
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                const Text("Descripci贸n", style: TextStyle(fontWeight: FontWeight.bold)),
                TextButton.icon(
                  onPressed: _procesandoIA ? null : _activarCamaraIA,
                  icon: _procesandoIA 
                    ? const SizedBox(width: 15, height: 15, child: CircularProgressIndicator(strokeWidth: 2)) 
                    : const Icon(Icons.auto_awesome, size: 18),
                  label: Text(_procesandoIA ? "Procesando..." : "Escanear con IA"),
                  style: TextButton.styleFrom(foregroundColor: Colors.cyan),
                )
              ],
            ),

            // Campo de Descripci贸n
            TextField(
              controller: _descCtrl,
              maxLines: 4,
              decoration: InputDecoration(
                filled: true,
                fillColor: _iaUtilizada ? Colors.cyan.withOpacity(0.05) : Colors.grey.shade50,
                border: OutlineInputBorder(borderRadius: BorderRadius.circular(10)),
                hintText: "Explica el problema o usa la IA...",
              ),
            ),
            const SizedBox(height: 20),

            // T铆tulo
            TextField(
              controller: _tituloCtrl,
              decoration: InputDecoration(
                labelText: "T铆tulo corto del problema",
                border: OutlineInputBorder(borderRadius: BorderRadius.circular(10)),
              ),
            ),
            const SizedBox(height: 40),

            // Bot贸n Enviar
            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFF2C3E50),
                  padding: const EdgeInsets.symmetric(vertical: 18),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12))
                ),
                onPressed: () {
                  if (_tituloCtrl.text.isEmpty) return;
                  
                  // Guardado en la lista global
                  GestorReparaciones.tickets.insert(0, {
                    "titulo": _tituloCtrl.text,
                    "categoria": _categoriaSeleccionada,
                    "estado": "Pendiente",
                    "color": Colors.grey,
                    "fecha": "Hoy",
                    "prioridad": _urgencia
                  });
                  Navigator.pop(context);
                },
                child: const Text("ENVIAR REPORTE", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
              ),
            )
          ],
        ),
      ),
    );
  }
}


// ============================================================================
//  27. MDULO DE GESTIN DE REPARACIONES (VISTA PROPIETARIO - MEJORADO)
// ============================================================================

class PantallaAdminReparaciones extends StatefulWidget {
  const PantallaAdminReparaciones({super.key});

  @override
  State<PantallaAdminReparaciones> createState() => _PantallaAdminReparacionesState();
}

class _PantallaAdminReparacionesState extends State<PantallaAdminReparaciones> {
  @override
  Widget build(BuildContext context) {
    final tickets = GestorReparaciones.tickets; 

    return Scaffold(
      backgroundColor: Colors.grey.shade50,
      appBar: AppBar(
        title: const Text("Gesti贸n de Mantenimiento", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
        backgroundColor: const Color(0xFF2C3E50),
        iconTheme: const IconThemeData(color: Colors.white),
        elevation: 0,
      ),
      body: tickets.isEmpty
          ? Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(Icons.inbox, size: 80, color: Colors.grey.shade300),
                  const SizedBox(height: 20),
                  const Text("No hay solicitudes pendientes", style: TextStyle(color: Colors.grey)),
                ],
              ),
            )
          : ListView.builder(
              padding: const EdgeInsets.all(20),
              itemCount: tickets.length,
              itemBuilder: (context, index) {
                final ticket = tickets[index];
                return GestureDetector(
                  onTap: () {
                    // AL HACER CLIC: Vamos al detalle
                    Navigator.push(
                      context,
                      MaterialPageRoute(
                        builder: (context) => PantallaDetalleTicket(
                          ticketIndex: index,
                          ticketData: ticket,
                          onUpdate: () => setState((){}), // Para refrescar la lista al volver
                        )
                      )
                    );
                  },
                  child: Container(
                    margin: const EdgeInsets.only(bottom: 15),
                    padding: const EdgeInsets.all(15),
                    decoration: BoxDecoration(
                      color: Colors.white,
                      borderRadius: BorderRadius.circular(15),
                      boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.05), blurRadius: 10)],
                    ),
                    child: Row(
                      children: [
                        // Icono de estado (Puntito de color)
                        Container(
                          width: 50, height: 50,
                          decoration: BoxDecoration(
                            color: (ticket['color'] as Color).withOpacity(0.1),
                            borderRadius: BorderRadius.circular(10)
                          ),
                          child: Icon(Icons.build, color: ticket['color']),
                        ),
                        const SizedBox(width: 15),
                        // Textos
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(ticket['titulo'], style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
                              const SizedBox(height: 5),
                              Row(
                                children: [
                                  Text(ticket['categoria'], style: const TextStyle(color: Colors.grey, fontSize: 12)),
                                  const SizedBox(width: 10),
                                  Container(
                                    padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                                    decoration: BoxDecoration(
                                      color: _getColorPrioridad(ticket['prioridad'] ?? "Media").withOpacity(0.1),
                                      borderRadius: BorderRadius.circular(4)
                                    ),
                                    child: Text(
                                      "Urgencia ${ticket['prioridad'] ?? 'Media'}",
                                      style: TextStyle(fontSize: 10, color: _getColorPrioridad(ticket['prioridad'] ?? "Media"), fontWeight: FontWeight.bold)
                                    ),
                                  )
                                ],
                              )
                            ],
                          ),
                        ),
                        // Flechita para indicar que se puede abrir
                        const Icon(Icons.chevron_right, color: Colors.grey),
                      ],
                    ),
                  ),
                );
              },
            ),
    );
  }

  Color _getColorPrioridad(String prioridad) {
    if (prioridad == "Alta") return Colors.red;
    if (prioridad == "Baja") return Colors.green;
    return Colors.orange;
  }
}

// --- NUEVA PANTALLA: DETALLE DEL TICKET (LO QUE FALTABA) ---
class PantallaDetalleTicket extends StatefulWidget {
  final int ticketIndex;
  final Map<String, dynamic> ticketData;
  final VoidCallback onUpdate;

  const PantallaDetalleTicket({super.key, required this.ticketIndex, required this.ticketData, required this.onUpdate});

  @override
  State<PantallaDetalleTicket> createState() => _PantallaDetalleTicketState();
}

class _PantallaDetalleTicketState extends State<PantallaDetalleTicket> {
  late String estadoActual;

  @override
  void initState() {
    super.initState();
    estadoActual = widget.ticketData['estado'];
  }

  void _cambiarEstado(String nuevoEstado, Color nuevoColor) {
    setState(() {
      estadoActual = nuevoEstado;
      // Actualizamos la base de datos global
      GestorReparaciones.tickets[widget.ticketIndex]['estado'] = nuevoEstado;
      GestorReparaciones.tickets[widget.ticketIndex]['color'] = nuevoColor;
    });
    widget.onUpdate(); // Avisamos a la pantalla anterior
    
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text("Estado actualizado a: $nuevoEstado"), backgroundColor: nuevoColor)
    );
  }

  @override
  Widget build(BuildContext context) {
    final t = widget.ticketData;
    
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        title: Text("Ticket #${1000 + widget.ticketIndex}", style: const TextStyle(color: Colors.black, fontWeight: FontWeight.bold)),
        backgroundColor: Colors.white,
        elevation: 0,
        leading: const BackButton(color: Colors.black),
        actions: [
          Center(
            child: Padding(
              padding: const EdgeInsets.only(right: 20),
              child: Text(
                t['fecha'], 
                style: const TextStyle(color: Colors.grey, fontWeight: FontWeight.bold)
              ),
            ),
          )
        ],
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // 1. CABECERA DE ESTADO
            Container(
              width: double.infinity,
              padding: const EdgeInsets.all(20),
              decoration: BoxDecoration(
                color: (t['color'] as Color).withOpacity(0.1),
                borderRadius: BorderRadius.circular(15),
                border: Border.all(color: (t['color'] as Color).withOpacity(0.3))
              ),
              child: Column(
                children: [
                  Text("ESTADO ACTUAL", style: TextStyle(color: (t['color'] as Color), fontSize: 10, fontWeight: FontWeight.bold, letterSpacing: 1.5)),
                  const SizedBox(height: 5),
                  Text(estadoActual.toUpperCase(), style: TextStyle(color: (t['color'] as Color), fontSize: 24, fontWeight: FontWeight.bold)),
                ],
              ),
            ),
            
            const SizedBox(height: 30),

            // 2. INFORMACIN DEL DAO
            Row(
              children: [
                const Icon(Icons.warning_amber_rounded, color: Colors.orange, size: 28),
                const SizedBox(width: 10),
                Expanded(
                  child: Text(t['titulo'], style: const TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
                ),
              ],
            ),
            
            const SizedBox(height: 20),
            const Divider(),
            const SizedBox(height: 20),

            // 3. DESCRIPCIN TCNICA (IA)
            const Text("INFORME TCNICO DEL INQUILINO", style: TextStyle(fontWeight: FontWeight.bold, color: Colors.grey)),
            const SizedBox(height: 10),
            Container(
              width: double.infinity,
              padding: const EdgeInsets.all(15),
              decoration: BoxDecoration(
                color: Colors.grey.shade50,
                borderRadius: BorderRadius.circular(10),
                border: Border.all(color: Colors.grey.shade200)
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                   // Etiqueta visual de que es IA
                   Container(
                     padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                     decoration: BoxDecoration(color: Colors.cyan.shade50, borderRadius: BorderRadius.circular(4)),
                     child: const Row(
                       mainAxisSize: MainAxisSize.min,
                       children: [
                         Icon(Icons.auto_awesome, size: 10, color: Colors.cyan),
                         SizedBox(width: 4),
                         Text("Generado por IA", style: TextStyle(fontSize: 10, color: Colors.cyan, fontWeight: FontWeight.bold)),
                       ],
                     ),
                   ),
                   const SizedBox(height: 10),
                   Text(
                     // Leemos la descripci贸n o ponemos un texto por defecto
                     t.containsKey('descripcion') ? t['descripcion'] : "Detecci贸n IA: Falla reportada en ${t['categoria']}. Se observan signos de deterioro que requieren atenci贸n t茅cnica. Prioridad asignada: ${t['prioridad']}.",
                     style: const TextStyle(fontSize: 15, height: 1.5, color: Colors.black87),
                   ),
                ],
              ),
            ),

            const SizedBox(height: 40),

            // 4. ACCIONES DEL PROPIETARIO
            if (estadoActual == "Pendiente") ...[
              const Text("ACCIONES REQUERIDAS", style: TextStyle(fontWeight: FontWeight.bold, color: Colors.grey)),
              const SizedBox(height: 15),
              Row(
                children: [
                  Expanded(
                    child: OutlinedButton(
                      onPressed: () => _cambiarEstado("Rechazado", Colors.red),
                      style: OutlinedButton.styleFrom(padding: const EdgeInsets.symmetric(vertical: 15), foregroundColor: Colors.red, side: const BorderSide(color: Colors.red)),
                      child: const Text("RECHAZAR"),
                    ),
                  ),
                  const SizedBox(width: 15),
                  Expanded(
                    child: ElevatedButton(
                      onPressed: () => _cambiarEstado("En Proceso", Colors.blue),
                      style: ElevatedButton.styleFrom(padding: const EdgeInsets.symmetric(vertical: 15), backgroundColor: const Color(0xFF2C3E50)),
                      child: const Text("AUTORIZAR REPARACIN", style: TextStyle(color: Colors.white)),
                    ),
                  ),
                ],
              )
            ] else if (estadoActual == "En Proceso") ...[
              SizedBox(
                width: double.infinity,
                child: ElevatedButton.icon(
                  onPressed: () => _cambiarEstado("Finalizado", Colors.green),
                  icon: const Icon(Icons.check_circle, color: Colors.white),
                  label: const Text("MARCAR COMO FINALIZADO", style: TextStyle(color: Colors.white)),
                  style: ElevatedButton.styleFrom(backgroundColor: Colors.green, padding: const EdgeInsets.symmetric(vertical: 15)),
                ),
              )
            ]
          ],
        ),
      ),
    );
  }
}

// 28. PANTALLA DE PASARELA (SELECCIN DE MTODO)
class PantallaPasarelaPago extends StatefulWidget {
  final String monto;
  final String concepto;

  const PantallaPasarelaPago({super.key, required this.monto, required this.concepto});

  @override
  State<PantallaPasarelaPago> createState() => _PantallaPasarelaPagoState();
}

class _PantallaPasarelaPagoState extends State<PantallaPasarelaPago> {
  int _metodoSeleccionado = -1; // -1 significa ninguno
  bool _procesando = false;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.grey.shade50,
      appBar: AppBar(
        title: const Text("Pasarela de Pagos ", style: TextStyle(color: Colors.black, fontWeight: FontWeight.bold)),
        backgroundColor: Colors.white,
        elevation: 0,
        leading: const BackButton(color: Colors.black),
      ),
      body: Column(
        children: [
          // Resumen del Pago
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(25),
            color: Colors.white,
            child: Column(
              children: [
                // --- VALIDACIN DE PUNTUALIDAD ---
                Container(
                  margin: const EdgeInsets.only(bottom: 15),
                  padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                  decoration: BoxDecoration(color: Colors.green.shade50, borderRadius: BorderRadius.circular(10), border: Border.all(color: Colors.green.shade200)),
                  child: Row(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Icon(Icons.verified, size: 16, color: Colors.green.shade700),
                      const SizedBox(width: 8),
                      Text("Pago A TIEMPO: Bono de Racha Activo", style: TextStyle(color: Colors.green.shade800, fontWeight: FontWeight.bold, fontSize: 12)),
                    ],
                  ),
                ),
                // ---------------------------------

                const Text("Total a Pagar", style: TextStyle(color: Colors.grey, fontSize: 14)),
                const SizedBox(height: 5),
                Text(widget.monto, style: const TextStyle(fontSize: 32, fontWeight: FontWeight.w900, color: Colors.blue)),
                const SizedBox(height: 10),
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                  decoration: BoxDecoration(color: Colors.blue.shade50, borderRadius: BorderRadius.circular(20)),
                  child: Text(widget.concepto, style: TextStyle(color: Colors.blue.shade800, fontWeight: FontWeight.bold)),
                )
              ],
            ),
          ),
          
          const SizedBox(height: 20),
          const Padding(
            padding: EdgeInsets.symmetric(horizontal: 20),
            child: Align(alignment: Alignment.centerLeft, child: Text("Elige tu m茅todo de pago", style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold))),
          ),
          const SizedBox(height: 15),

          // Lista de M茅todos
          Expanded(
            child: ListView(
              padding: const EdgeInsets.symmetric(horizontal: 20),
              children: [
                _MetodoPagoItem(
                  index: 0, 
                  nombre: "Nequi", 
                  color: const Color(0xFF200020), 
                  icon: Icons.phone_android, 
                  seleccionado: _metodoSeleccionado == 0,
                  onTap: () => setState(() => _metodoSeleccionado = 0)
                ),
                _MetodoPagoItem(
                  index: 1, 
                  nombre: "Daviplata", 
                  color: const Color(0xFFED1C24), 
                  icon: Icons.home_work, 
                  seleccionado: _metodoSeleccionado == 1,
                  onTap: () => setState(() => _metodoSeleccionado = 1)
                ),
                _MetodoPagoItem(
                  index: 2, 
                  nombre: "PSE (Cualquier Banco)", 
                  color: const Color(0xFF005EB8), 
                  icon: Icons.account_balance, 
                  seleccionado: _metodoSeleccionado == 2,
                  onTap: () => setState(() => _metodoSeleccionado = 2)
                ),
                _MetodoPagoItem(
                  index: 3, 
                  nombre: "Tarjeta de Cr茅dito", 
                  color: Colors.black87, 
                  icon: Icons.credit_card, 
                  seleccionado: _metodoSeleccionado == 3,
                  onTap: () => setState(() => _metodoSeleccionado = 3)
                ),
              ],
            ),
          ),

          // Bot贸n Pagar (Con espacio para Xiaomi)
          Container(
            padding: const EdgeInsets.fromLTRB(20, 20, 20, 60), // Margen inferior aumentado
            decoration: BoxDecoration(color: Colors.white, boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.05), blurRadius: 10, offset: const Offset(0, -5))]),
            child: SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                onPressed: _metodoSeleccionado == -1 ? null : _procesarPago,
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.green.shade600,
                  disabledBackgroundColor: Colors.grey.shade300,
                  padding: const EdgeInsets.symmetric(vertical: 18),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15))
                ),
                child: _procesando 
                  ? const SizedBox(width: 20, height: 20, child: CircularProgressIndicator(color: Colors.white, strokeWidth: 2))
                  : const Text("PAGAR AHORA", style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold)),
              ),
            ),
          )
        ],
      ),
    );
  }

  void _procesarPago() async {
    setState(() => _procesando = true);
    // Simular tiempo de banco
    await Future.delayed(const Duration(seconds: 3));
    
    if (mounted) {
      setState(() => _procesando = false);
      // Navegar al recibo (Comprobante)
      Navigator.pushReplacement(context, MaterialPageRoute(builder: (c) => PantallaComprobantePago(monto: widget.monto, metodo: _obtenerNombreMetodo())));
    }
  }

  String _obtenerNombreMetodo() {
    switch(_metodoSeleccionado) {
      case 0: return "Nequi";
      case 1: return "Daviplata";
      case 2: return "PSE";
      case 3: return "Tarjeta Cr茅dito ⑩88";
      default: return "Desconocido";
    }
  }
}

// 29. PANTALLA DE RECIBO (COMPROBANTE CON RECOMPENSA)
class PantallaComprobantePago extends StatelessWidget {
  final String monto;
  final String metodo;

  const PantallaComprobantePago({super.key, required this.monto, required this.metodo});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      body: Center(
        child: Padding(
          padding: const EdgeInsets.all(30),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Container(
                padding: const EdgeInsets.all(25),
                decoration: BoxDecoration(color: Colors.green.shade50, shape: BoxShape.circle),
                child: Icon(Icons.check_rounded, size: 80, color: Colors.green.shade600),
              ),
              const SizedBox(height: 30),
              
              const Text("隆Pago Exitoso!", style: TextStyle(fontSize: 28, fontWeight: FontWeight.w900, color: Colors.black87)),
              const SizedBox(height: 20),

              // --- NUEVA TARJETA DE RECOMPENSA ---
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 15),
                decoration: BoxDecoration(
                  gradient: const LinearGradient(colors: [Color(0xFFFFC107), Color(0xFFFF9800)]), // Dorado
                  borderRadius: BorderRadius.circular(15),
                  boxShadow: [BoxShadow(color: Colors.orange.withOpacity(0.3), blurRadius: 10, offset: const Offset(0, 5))]
                ),
                child: const Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(Icons.stars, color: Colors.white, size: 30),
                    SizedBox(width: 15),
                    Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text("隆Ganaste +100 Puntos!", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 16)),
                        Text("Tu historial ahora es impecable.", style: TextStyle(color: Colors.white70, fontSize: 12)),
                      ],
                    )
                  ],
                ),
              ),
              // ------------------------------------
              
              const SizedBox(height: 40),
              
              // Ticket
              Container(
                padding: const EdgeInsets.all(20),
                decoration: BoxDecoration(
                  border: Border.all(color: Colors.grey.shade200),
                  borderRadius: BorderRadius.circular(20)
                ),
                child: Column(
                  children: [
                    _RowTicket("Valor Pagado", monto, true),
                    const Divider(height: 30),
                    _RowTicket("Fecha", "${DateTime.now().day}/${DateTime.now().month}/${DateTime.now().year}", false),
                    const SizedBox(height: 15),
                    _RowTicket("Hora", "${DateTime.now().hour}:${DateTime.now().minute}", false),
                    const SizedBox(height: 15),
                    _RowTicket("M茅todo", metodo, false),
                    const SizedBox(height: 15),
                    _RowTicket("Ref. Transacci贸n", "TX-${DateTime.now().millisecondsSinceEpoch.toString().substring(6)}", false),
                  ],
                ),
              ),

              const Spacer(),
              
              Padding(
                padding: const EdgeInsets.only(bottom: 30),
                child: SizedBox(
                  width: double.infinity,
                  child: ElevatedButton(
                    onPressed: () => Navigator.pop(context),
                    style: ElevatedButton.styleFrom(backgroundColor: Colors.black, padding: const EdgeInsets.symmetric(vertical: 18), shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15))),
                    child: const Text("VOLVER A MIS ARRIENDOS", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
                  ),
                ),
              )
            ],
          ),
        ),
      ),
    );
  }

  Widget _RowTicket(String label, String value, bool isBold) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Text(label, style: const TextStyle(color: Colors.grey)),
        Text(value, style: TextStyle(fontWeight: isBold ? FontWeight.bold : FontWeight.normal, fontSize: isBold ? 18 : 14))
      ],
    );
  }
}

// 30. WIDGET DE ITEM DE PAGO
class _MetodoPagoItem extends StatelessWidget {
  final int index;
  final String nombre;
  final Color color;
  final IconData icon;
  final bool seleccionado;
  final VoidCallback onTap;

  const _MetodoPagoItem({required this.index, required this.nombre, required this.color, required this.icon, required this.seleccionado, required this.onTap});

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        margin: const EdgeInsets.only(bottom: 15),
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.circular(15),
          border: Border.all(color: seleccionado ? color : Colors.grey.shade200, width: seleccionado ? 2 : 1),
          boxShadow: [if(seleccionado) BoxShadow(color: color.withOpacity(0.1), blurRadius: 10)]
        ),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(10),
              decoration: BoxDecoration(color: color.withOpacity(0.1), shape: BoxShape.circle),
              child: Icon(icon, color: color, size: 24),
            ),
            const SizedBox(width: 15),
            Expanded(child: Text(nombre, style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16, color: seleccionado ? Colors.black : Colors.grey.shade600))),
            if (seleccionado) Icon(Icons.check_circle, color: color)
          ],
        ),
      ),
    );
  }
}

// 31. ICONOS ANIMADOS
class LottieNetworkIcon extends StatelessWidget {
  final String url; 
  final double size;
  final bool repetir;

  const LottieNetworkIcon({
    super.key, 
    required this.url, 
    this.size = 150, 
    this.repetir = true
  });

  @override
  Widget build(BuildContext context) {
    return Lottie.network(
      url,
      width: size,
      height: size,
      fit: BoxFit.contain,
      repeat: repetir,
    );
  }
}


// 32 WIDGETS GENRICOS ---
class _MapaGoogleSimulado extends StatelessWidget { final bool isEditable; const _MapaGoogleSimulado({required this.isEditable}); @override Widget build(BuildContext context) { return Stack(children: [Container(color: const Color(0xFFE3F2FD)), const Center(child: Icon(Icons.location_on, size: 40, color: Colors.red))]); } }
class _DatoClave extends StatelessWidget { final String label, valor; final IconData icon; final Color color; const _DatoClave({required this.label, required this.valor, required this.icon, required this.color}); @override Widget build(BuildContext context) { return Expanded(child: Container(padding: const EdgeInsets.all(8), decoration: BoxDecoration(color: color.withValues(alpha: 0.1), borderRadius: BorderRadius.circular(10)), child: Column(children: [Icon(icon, size: 16, color: color), Text(label, style: TextStyle(fontSize: 10, color: color, fontWeight: FontWeight.bold)), Text(valor, style: const TextStyle(fontSize: 11, fontWeight: FontWeight.bold))]))); } }
class _PropiedadCard extends StatelessWidget { final String nombre; final String estado; final Color colorEstado; final String inquilino; const _PropiedadCard({required this.nombre, required this.estado, required this.colorEstado, required this.inquilino}); @override Widget build(BuildContext context) { return Container(margin: const EdgeInsets.only(bottom: 15), padding: const EdgeInsets.all(15), decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(15), boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 10)]), child: Row(children: [const Icon(Icons.home, color: Colors.grey), const SizedBox(width: 15), Expanded(child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [Text(nombre, style: const TextStyle(fontWeight: FontWeight.bold)), Text(inquilino, style: const TextStyle(color: Colors.grey, fontSize: 12))])), Container(padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 5), decoration: BoxDecoration(color: colorEstado.withValues(alpha: 0.1), borderRadius: BorderRadius.circular(10)), child: Text(estado, style: TextStyle(color: colorEstado, fontWeight: FontWeight.bold, fontSize: 12)))])); } }
class _AccesoRapido extends StatelessWidget { final IconData icon; final String label; final Color color; final VoidCallback? onTap; const _AccesoRapido({required this.icon, required this.label, required this.color, this.onTap}); @override Widget build(BuildContext context) { return GestureDetector(onTap: onTap, child: Container(width: 100, padding: const EdgeInsets.all(15), decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(15), border: Border.all(color: Colors.grey.shade200)), child: Column(children: [CircleAvatar(backgroundColor: color.withValues(alpha: 0.1), child: Icon(icon, color: color)), const SizedBox(height: 10), Text(label, style: const TextStyle(fontSize: 12, fontWeight: FontWeight.bold))]))); } }
class _BotonAccion extends StatelessWidget { final IconData icon; final String label; final Color color; final Color iconColor; const _BotonAccion({required this.icon, required this.label, required this.color, required this.iconColor}); @override Widget build(BuildContext context) { return Container(width: 100, padding: const EdgeInsets.symmetric(vertical: 15), decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(20), boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 10, offset: const Offset(0, 5))]), child: Column(children: [Container(padding: const EdgeInsets.all(10), decoration: BoxDecoration(color: color, shape: BoxShape.circle), child: Icon(icon, color: iconColor)), const SizedBox(height: 10), Text(label, textAlign: TextAlign.center, style: const TextStyle(fontSize: 12, fontWeight: FontWeight.bold))])); } }
class _ItemHistorial extends StatelessWidget { final String mes; final String estado; final Color colorEstado; final String fecha; const _ItemHistorial({required this.mes, required this.estado, required this.colorEstado, required this.fecha}); @override Widget build(BuildContext context) { return Container(margin: const EdgeInsets.only(bottom: 15), padding: const EdgeInsets.all(15), decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(15), border: Border.all(color: Colors.grey.shade100)), child: Row(mainAxisAlignment: MainAxisAlignment.spaceBetween, children: [Row(children: [const Icon(Icons.receipt_long, color: Colors.grey), const SizedBox(width: 15), Column(crossAxisAlignment: CrossAxisAlignment.start, children: [Text(mes, style: const TextStyle(fontWeight: FontWeight.bold)), Text(fecha, style: const TextStyle(fontSize: 12, color: Colors.grey))])]), Container(padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 5), decoration: BoxDecoration(color: colorEstado.withValues(alpha: 0.1), borderRadius: BorderRadius.circular(10)), child: Text(estado, style: TextStyle(color: colorEstado, fontWeight: FontWeight.bold, fontSize: 12)))])); } }
class _FiltroChip extends StatelessWidget { final String label; final bool activo; const _FiltroChip({required this.label, required this.activo}); @override Widget build(BuildContext context) { return Container(margin: const EdgeInsets.only(right: 10), padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 8), decoration: BoxDecoration(color: activo ? Colors.blue : Colors.white, borderRadius: BorderRadius.circular(20), border: Border.all(color: activo ? Colors.blue : Colors.grey.shade300)), child: Center(child: Text(label, style: TextStyle(color: activo ? Colors.white : Colors.grey.shade800, fontWeight: FontWeight.bold)))); } }
class _ComodidadItem extends StatelessWidget { final IconData icon; final String label; const _ComodidadItem({required this.icon, required this.label}); @override Widget build(BuildContext context) { return Column(children: [Container(padding: const EdgeInsets.all(12), decoration: BoxDecoration(color: Colors.grey.shade100, borderRadius: BorderRadius.circular(12)), child: Icon(icon, size: 24, color: Colors.grey.shade800)), const SizedBox(height: 5), Text(label, style: const TextStyle(fontSize: 12, color: Colors.grey))]); } }
class _StatItem extends StatelessWidget { final IconData icon; final String label; const _StatItem({required this.icon, required this.label}); @override Widget build(BuildContext context) { return Column(children: [Container(padding: const EdgeInsets.all(12), decoration: BoxDecoration(color: const Color(0xFFE3F2FD), shape: BoxShape.circle, border: Border.all(color: Colors.blue.shade100, width: 1)), child: Icon(icon, size: 28, color: const Color(0xFF1565C0))), const SizedBox(height: 8), Text(label, textAlign: TextAlign.center, style: TextStyle(fontSize: 12, color: Colors.grey.shade700, fontWeight: FontWeight.w600, height: 1.2))]); } }
class _TimeChip extends StatelessWidget { final String label; final bool selected; final VoidCallback onTap; const _TimeChip({required this.label, required this.selected, required this.onTap}); @override Widget build(BuildContext context) { return GestureDetector(onTap: onTap, child: Container(width: 100, padding: const EdgeInsets.symmetric(vertical: 12), decoration: BoxDecoration(color: selected ? Colors.blue.shade50 : Colors.white, borderRadius: BorderRadius.circular(10), border: Border.all(color: selected ? Colors.blue : Colors.grey.shade300)), child: Center(child: Text(label, style: TextStyle(color: selected ? Colors.blue.shade800 : Colors.black87, fontWeight: FontWeight.bold))))); } }

